/* 
 *  Copyright IBM Corp. 2025
 *  
 *  This source code is licensed under the Apache-2.0 license found in the
 *  LICENSE file in the root directory of this source tree.
 */

@use "@carbon/layout";
@use "@carbon/styles/scss/theme";
@use "@carbon/styles/scss/motion";
@use "../../../styles/chatTheme";

// Default tour styling for desktop.
@media screen and (prefers-reduced-motion: reduce) {
  .WACTour {
    position: fixed;
    z-index: var(--cds-chat-BASE-z-index);
    display: flex;
    flex-direction: column;
    border-radius: layout.$spacing-04;
    animation: none;
    background-color: theme.$background;
    box-shadow: chatTheme.$BASE-box-shadow;
    color: theme.$text-primary;
    inline-size: var(--cds-chat-BASE-width);
    inset-block-end: var(--cds-chat-LAUNCHER-position-bottom);
    inset-inline-end: var(--cds-chat-LAUNCHER-position-bottom);
  }
}

.WACTour {
  position: fixed;
  z-index: var(--cds-chat-BASE-z-index);
  display: flex;
  flex-direction: column;
  border-radius: layout.$spacing-04;
  animation: WACLauncherIn motion.$duration-moderate-01
    motion.motion(entrance, expressive) both;
  background-color: theme.$background;
  box-shadow: chatTheme.$BASE-box-shadow;
  color: theme.$text-primary;
  inline-size: var(--cds-chat-BASE-width);
  inset-block-end: var(--cds-chat-LAUNCHER-position-bottom);
  inset-inline-end: var(--cds-chat-LAUNCHER-position-bottom);
}

// For a mobile device in portrait mode we want the tour to be almost the full device width.
.WAC-isPhone.WAC-isPhonePortraitMode .WACTour {
  inline-size: unset;
  inset-inline-start: var(--cds-chat-LAUNCHER-position-bottom);
}

// For a mobile device in landscape mode we want the tour to be the same width as the main window normally is on desktop.
.WAC-isPhone:not(.WAC-isPhonePortraitMode) .WACTour {
  inline-size: 360px;
}

// Set overflow hidden on the wrapper to round the top right of the scrollbar if there is one.
.WACTourStep__Wrapper {
  overflow: hidden;
  border-start-end-radius: layout.$spacing-04;
  border-start-start-radius: layout.$spacing-04;

  // The border radius was being ignored on mobile safari when there was overflow within the WACTourStep (first child of
  // the wrapper). "isolation" fixes this by "creating a new stacking context" - which seems to mean making sure the
  // children respect the parents paint layer.
  // https://stackoverflow.com/questions/49066011/overflow-hidden-with-border-radius-not-working-on-safari
  isolation: isolate;
}

// Make sure the step content can overflow vertically but not horizontally.
// For desktop we want the content to be 1/2 of Carbon AI Chat height.
.WACTourStep {
  overflow: hidden auto;
  max-block-size: calc((var(--cds-chat-BASE-max-height) / 2));
  min-block-size: layout.$spacing-11;
}

// For a mobile device in portrait mode we want the content to be 40% of the screen height.
.WAC-isPhone.WAC-isPhonePortraitMode .WACTourStep {
  max-block-size: 40vh;
}

// For a mobile device in landscape mode we want to limit the height to top of the screen.
.WAC-isPhone:not(.WAC-isPhonePortraitMode) .WACTourStep {
  // The height of the screen, minus the height of the close and minimize buttons, the margin beneath them, the height of
  // the control bar, and the margin above and below the entire component.
  max-block-size: calc(
    100vh - #{layout.$spacing-07} - #{layout.$spacing-03} - 40px -
      var(--cds-chat-LAUNCHER-position-bottom) -
      var(--cds-chat-LAUNCHER-position-bottom)
  );
}

// Add padding around parts of the tour that show text.
.WACTourStep__Text,
.WACTourStep .WACTextHolderTile,
.WACTourStep .WAC__inlineError {
  padding: layout.$spacing-05 layout.$spacing-06;
}

.WACTourStep__Skeleton {
  block-size: 221px;
  border-start-end-radius: layout.$spacing-04;
  border-start-start-radius: layout.$spacing-04;
}

.WACTourStep__SkeletonPlaceholder {
  block-size: 100%;
  inline-size: 100%;
}

// Set the font size and line height for the text steps and the text descriptions on the image and video steps. Make
// sure markdown has the correct font size and line height as well.
.WACTourStep__Text p.WACWidget__MarkdownP,
.WACTourStep .WACTextHolderTile__Description,
.WACTourStep .WAC__inlineError--text,
.WACTourStep a,
.WACTourStep ul,
.WACTourStep ol,
.WACTourStep li,
.WACTourStep th,
.WACTourStep td {
  font-size: var(--cds-chat-BASE-font-size-large);
  line-height: var(--cds-chat-BASE-line-height-large);
}

// Make sure markdown images down scale to fit the tour step.
.WACTourStep img {
  max-inline-size: 100%;
}

// Set the background color of the text descriptions on the image and video steps.
.WACTourStep .WACTextHolderTile {
  background-color: theme.$background;
}

// Allow the text descriptions on the image and video steps to grow vertically without overflowing to ellipsis.
.WACTourStep
  .WACTextHolderTile__Wrapper.WACWidget__textEllipsis
  .WACTextHolderTile__Description {
  -webkit-line-clamp: unset;
}

// Remove the default rounded corners from the image and video components.
.WACTourStep .WAC__media-image,
.WACTourStep .WACMediaPlayer {
  border-radius: inherit;
}

// In case the media player iframe, or the image component, adds bars on the side to preserve the aspect ratio make sure
// the background color is dark grey.
.WACTourStep .WAC__imageHolder,
.WACTourStep .WACMediaPlayer .WACMediaPlayer__PlayerBackground {
  background-color: theme.$border-strong-01;
}

// Show a border between the text of a step (either text only, or image/video description) and the tour controls below.
.WACTour__Controls--empty > * {
  visibility: hidden;
}

// Hide all steps that aren't the current step off the screen. These steps are hidden with visibility: hidden instead of
// using display: none so the tour container component can do dynamic animations between steps based off the height of a
// step. A step's height can't be measured if it's styling is display: none.
.WACTourStep.WACTourStep--hidden {
  position: absolute;
  inset-block-end: 0;
  inset-inline-end: 0;
  visibility: hidden;
}

// Some of the video players (ahem facebook) don't like to respect being hidden so they need to be forced.
.WACTourStep.WACTourStep--hidden .WACMediaPlayer iframe {
  opacity: 0;
  visibility: hidden;
}

.WACTour__Controls {
  display: flex;
  border-block-start: var(--cds-chat-BASE-border-width-small) solid
    theme.$layer-03;
}

.WACTour__ControlsButton {
  display: flex;
  flex: auto;

  // Set the bias to 33% so that all buttons take up the same width.
  flex-basis: 33%;
  align-items: stretch;
  justify-content: center;

  // Remove the default padding from the carbon buttons so that the text of the "done" buttons are centered.
  padding: unset;
  max-inline-size: unset;

  .cds--popover-container {
    display: block;
    inline-size: 100%;

    button {
      inline-size: 100%;
    }
  }
}

.WACTour__ControlsButton:first-of-type .cds--btn {
  border-end-start-radius: layout.$spacing-04;
}

.WACTour__ControlsButton:last-of-type .cds--btn {
  flex: 1;
  border-end-end-radius: layout.$spacing-04;
}

.WACTour__ControlsButton:only-child .cds--btn {
  flex: 1;
}

.WACTour__ControlsButton--hidden {
  visibility: hidden;
}

.WACTour__CloseMinimizeWrapper {
  position: absolute;
  display: flex;
  border-radius: layout.$spacing-05;
  background-color: theme.$background;
  box-shadow: chatTheme.$BASE-box-shadow;

  // The height of the tag 32px, plus the 8px gap we want.
  inset-block-start: calc(-1 * (#{layout.$spacing-07} + #{layout.$spacing-03}));
  inset-inline-end: 0;
}

.WACTour__CloseMinimizeButton {
  padding: layout.$spacing-03;
  border: none;
  block-size: layout.$spacing-07;
  min-block-size: layout.$spacing-07;
}

.WACTour__CloseMinimizeWrapper
  .cds--popover-container:first-of-type
  .WACTour__CloseMinimizeButton {
  border-end-start-radius: layout.$spacing-05;
  border-start-start-radius: layout.$spacing-05;
  padding-inline: 20px layout.$spacing-05;
}

.WACTour__CloseMinimizeWrapper
  .cds--popover-container:last-of-type
  .WACTour__CloseMinimizeButton {
  border-end-end-radius: layout.$spacing-05;
  border-start-end-radius: layout.$spacing-05;
  padding-inline: layout.$spacing-05 20px;
}

.WACTour__CloseMinimizeWrapper
  .cds--popover-container:only-child
  .WACTour__CloseMinimizeButton {
  padding-inline-end: layout.$spacing-05;
}

.WACTour__CloseMinimizeDivider {
  background-color: theme.$border-subtle-00;
  inline-size: 1px;
}

.WACTour .cds--inline-notification {
  margin: 0;
}

.WACTour__StatusContainer {
  position: relative;
}

.WACTour .WACLoadingBar__ConnectingAnimation {
  position: absolute;
  inset-block-end: 0;
  inset-inline-start: 0;
}

.WACTour__ErrorScreen {
  padding: layout.$spacing-05 layout.$spacing-06;
  border-radius: layout.$spacing-04;
  background-color: theme.$background;
  block-size: 138px;
}

.WACTour__ErrorHeader {
  display: flex;
  align-items: center;
  font-weight: 600;
}

.WACTour__ErrorBody {
  margin-inline-start: layout.$spacing-07;
}

.WACTour .WACTour__ErrorIcon {
  fill: theme.$support-error;
  margin-inline-end: layout.$spacing-04;
}

.WACTour__ErrorText {
  margin-block-end: layout.$spacing-05;
}

.WACTour__ErrorButton {
  margin-block-start: layout.$spacing-02;
}

.WACContainer--render[dir="rtl"] .WACTour {
  inset-inline: var(--cds-chat-LAUNCHER-position-right) unset;
}

.WACContainer--render[dir="rtl"] .WACTour__CloseMinimizeWrapper {
  inset-inline: 0 unset;
}

.WACContainer--render[dir="rtl"]
  .WACTour__CloseMinimizeWrapper
  .cds--popover-container:first-of-type
  .WACTour__CloseMinimizeButton {
  border-radius: 0 layout.$spacing-05 layout.$spacing-05 0;
}

.WACContainer--render[dir="rtl"]
  .WACTour__CloseMinimizeWrapper
  .cds--popover-container:last-of-type
  .WACTour__CloseMinimizeButton {
  border-radius: layout.$spacing-05 0 0 layout.$spacing-05;
}

.WACContainer--render[dir="rtl"]
  .WACTour__ControlsButton:first-of-type
  .cds--btn {
  border-radius: 0 0 layout.$spacing-04 0;
}

.WACContainer--render[dir="rtl"]
  .WACTour__ControlsButton:last-of-type
  .cds--btn {
  border-radius: 0 0 0 layout.$spacing-04;
}

.WACContainer--render[dir="rtl"] .WACTour__PreviousButton svg,
.WACContainer--render[dir="rtl"] .WACTour__NextButton svg {
  transform: rotate(180deg);
}

.WACTour .WACImage,
.WACTour .WACMediaPlayer {
  border: none;
  border-radius: 0;
}
