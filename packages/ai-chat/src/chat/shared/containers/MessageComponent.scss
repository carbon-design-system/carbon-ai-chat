/* 
 *  Copyright IBM Corp. 2025
 *  
 *  This source code is licensed under the Apache-2.0 license found in the
 *  LICENSE file in the root directory of this source tree.
 */

@use "@carbon/layout";
@use "@carbon/styles/scss/motion";
@use "@carbon/styles/scss/theme";
@use "@carbon/styles/scss/type";

$message-bar-width: 3px;

@media screen and (prefers-reduced-motion: reduce) {
  .WAC__message {
    position: relative;
    display: block;
    /* We cannot use margin on messages as that affects the position calculations that determine how to auto-scroll the
     panel. Padding on the .WAC__message--padding element must be used instead. */
    margin: 0;
    animation: none;
  }
}

.WAC__message {
  position: relative;
  display: block;

  /* We cannot use margin on messages as that affects the position calculations that determine how to auto-scroll the
   panel. Padding on the .WAC__message--padding element must be used instead. */
  margin: 0;
  animation: WACMessageIn motion.$duration-moderate-02
    motion.motion(entrance, productive) forwards;
}

.WAC__message.WAC__message--no-animation {
  animation: none;
}

.WAC__message.WAC__message--has-focus::after {
  position: absolute;
  box-sizing: border-box;
  border: solid 2px theme.$focus;
  block-size: 100%;
  content: "";
  inline-size: 100%;
  inset-block-start: 0;
  pointer-events: none;
}

/* The first and last messages have some extra padding. This will counteract that padding so the border appears balance. */
.WAC__message.WAC__message--firstMessage.WAC__message--has-focus::after {
  block-size: calc(100% - 0.5rem);
  inset-block-start: 0.5rem;
}

.WAC__message.WAC__message--lastMessage.WAC__message--has-focus::after {
  block-size: calc(100% - #{layout.$spacing-07} + 0.5rem);
  inset-block-end: calc(#{layout.$spacing-07} - 0.5rem);
}

.WAC__message .WAC__message-vertical-padding,
.WAC__message .WACUICustomizationElement--response {
  /*  WARNING: If we change this value it will effect the vertical alignment of existing custom message elements. */
  padding-block-start: layout.$spacing-05;
}

.WAC__message--withAvatarLine .WAC__message-vertical-padding,
.WAC__message--withAvatarLine .WACUICustomizationElement--response,
.WAC__message--option-response-without-title-or-description
  .WAC__message-vertical-padding,
.WAC__message--option-response-without-title-or-description
  .WACUICustomizationElement--response {
  /* If this is the avatar line or an option response without title or description then remove the padding-block-start
   from the message and the custom element. */
  padding-block-start: 0;
}

.WAC__message.WAC__message--custom .WAC__message-vertical-padding,
.WAC__message.WAC__message--custom .WACUICustomizationElement--response {
  padding-block: 0;
}

.WACMessage__AvatarLine
  + .WAC__message--padding
  .WAC__bot-message
  > div.WAC__received,
.WACMessage__AvatarLine
  + .WAC__message--padding
  .WAC__bot-message
  > div.WAC__received.WAC__received--carousel:not(
    .WAC__received--carouselSingle
  ):first-child,
.WACMessage__AvatarLine
  + .WAC__message--padding
  .WAC__bot-message
  > div.WAC__received.WAC__received--fullWidth:first-child {
  margin-block-start: layout.$spacing-03;
}

.WAC__message.WAC__message--lastMessage .WAC__message--padding {
  padding-block-end: layout.$spacing-06;
}

.WAC__message .WAC__received,
.WAC__message .WAC__sent-container {
  flex-grow: 1;
  margin-inline: layout.$spacing-05;
  min-inline-size: 0;
}

.WAC--wideWidth
  .WAC__message
  .WAC__received.WAC__received--conversationalSearch,
.WAC--wideWidth .WAC__message .WAC__received.WAC__received--search,
.WAC--wideWidth
  .WAC__message
  .WAC__received--carousel:not(.WAC__received--carouselSingle),
.WAC--wideWidth .WAC__message .WAC__received.WAC__received--fullWidth,
.WAC--narrowWidth
  .WAC__message
  .WAC__received.WAC__received--conversationalSearch,
.WAC--narrowWidth .WAC__message .WAC__received.WAC__received--search,
.WAC--narrowWidth
  .WAC__message
  .WAC__received--carousel:not(.WAC__received--carouselSingle),
.WAC--narrowWidth .WAC__message .WAC__received.WAC__received--fullWidth,
.WAC--standardWidth
  .WAC__message
  .WAC__received.WAC__received--conversationalSearch,
.WAC--standardWidth .WAC__message .WAC__received.WAC__received--search,
.WAC--standardWidth
  .WAC__message
  .WAC__received--carousel:not(.WAC__received--carouselSingle),
.WAC--standardWidth .WAC__message .WAC__received.WAC__received--fullWidth {
  margin-inline: 0;
}

/* When UI customization is on, there should be left padding so it's not hidden. */
.WAC--wideWidth
  .WAC__message
  .WACUICustomizationElement
  ~ .WAC__received--fullWidth,
.WAC--narrowWidth
  .WAC__message
  .WACUICustomizationElement
  ~ .WAC__received--fullWidth,
.WAC--standardWidth
  .WAC__message
  .WACUICustomizationElement
  ~ .WAC__received--fullWidth {
  /* Start = left margin + avatar + right margin. */
  margin-inline-start: calc(
    #{layout.$spacing-05} + 32px + #{layout.$spacing-03}
  );
}

.WAC__message a {
  color: theme.$link-primary;
  outline: none;
  text-decoration: none;
}

.WAC__message a:visited {
  color: theme.$link-primary;
}

.WAC__message a:hover {
  text-decoration: underline;
}

.WAC__message a:focus {
  text-decoration: underline;
}

.WAC__message::after {
  display: table;
  clear: both;
  content: "";
}

.WACMessages--welcome {
  min-block-size: 100%;
}

.WACMessages--welcome.WACMessages--welcome--typing {
  min-block-size: 100%;
}

.WAC__bot-message {
  position: relative;
  display: flex;
  flex-direction: row;
  max-inline-size: 100%;
}

.WAC__received--inlineError,
.WAC__received--text,
.WAC__message-userDefinedResponse {
  position: relative;
  color: theme.$text-primary;
  font-size: var(--cds-chat-BASE-font-size-med);
  line-height: var(--cds-chat-BASE-line-height-med);
  overflow-wrap: break-word;
  word-break: break-word;
  word-wrap: break-word;
}

.WAC__message-userDefinedResponse {
  max-inline-size: 100%;
}

.WAC__received--image {
  position: relative;
  inline-size: 90%;
  overflow-wrap: break-word;
  word-break: break-word;
  word-wrap: break-word;
}

.WAC__received--video,
.WAC__received--audio {
  inline-size: 100%;
  overflow-wrap: break-word;
  word-break: break-word;
  word-wrap: break-word;
}

/* TODO: Can remove all this in 9.0 */
.WAC__received--textContent {
  .cds--link:not(:has(.cds--link__icon)) {
    /* Carbon displays cds--link using display: inline-flex to allow icons to align well. In our narrow viewport this can
   lead to some funky linebreaks. This CSS will set cds--link to be display: inline if there is no icon. */
    display: inline;
  }

  .WACWidget__MarkdownP,
  .cds--data-table-content,
  .WACWidget__MarkdownBlockquote,
  .WACWidget__MarkdownImg,
  .cds--list--ordered:not(.cds--list--nested),
  .cds--list--unordered:not(.cds--list--nested),
  .WACWidget__MarkdownPre {
    margin-block: 0;
  }

  .cds--list--unordered:not(.cds--list--nested),
  .cds--list--ordered:not(.cds--list--nested) {
    padding: 0;
    padding-block: layout.$spacing-03;
  }

  .WACWidget__MarkdownP {
    @include type.type-style("body-01");

    font-size: var(--cds-chat-BASE-font-size-med);
    line-height: var(--cds-chat-BASE-line-height-large);
  }

  .WACWidget__MarkdownBlockquote {
    border-inline-start: 4px solid var(--cds-chat-ACCENT-color);
    padding-inline-start: layout.$spacing-03;
  }

  .WACWidget__MarkdownPre {
    @include type.type-style("code-02");

    overflow: auto hidden;
    padding: layout.$spacing-05;

    border: solid 1px theme.$chat-bubble-border;
    background-color: theme.$layer-02;
    white-space: pre-wrap;
  }

  .WACWidget__MarkdownImg {
    /* Make sure images in markdown don't overflow. */
    max-inline-size: 100%;
  }

  h1.WACWidget__MarkdownHeading,
  h2.WACWidget__MarkdownHeading,
  h3.WACWidget__MarkdownHeading,
  h4.WACWidget__MarkdownHeading,
  h5.WACWidget__MarkdownHeading,
  h6.WACWidget__MarkdownHeading {
    margin-block: 0;
  }

  h1.WACWidget__MarkdownHeading {
    @include type.type-style("heading-06");
  }

  h2.WACWidget__MarkdownHeading {
    @include type.type-style("heading-05");
  }

  h3.WACWidget__MarkdownHeading {
    @include type.type-style("heading-04");
  }

  h4.WACWidget__MarkdownHeading {
    @include type.type-style("heading-03");
  }

  h5.WACWidget__MarkdownHeading {
    @include type.type-style("heading-02");
  }

  h6.WACWidget__MarkdownHeading {
    @include type.type-style("heading-01");
  }

  .cds--data-table-content {
    overflow: auto hidden;
    overflow-wrap: normal;
    word-break: normal;
    word-wrap: normal;
  }
}

/* TODO: can remove WAC__received--withSpacing and .WAC__received--metablock in 9.0 */
.WAC__received--textContent.WAC__received--withSpacing,
.WAC__received--metablock,
.WAC__inlineError--text,
.WACCatastrophicError__ErrorBody,
.WACConversationalSearchText {
  .cds--link:not(:has(.cds--link__icon)) {
    /* Carbon displays cds--link using display: inline-flex to allow icons to align well. In our narrow viewport this can
   lead to some funky linebreaks. This CSS will set cds--link to be display: inline if there is no icon. */
    display: inline;
  }

  .WACWidget__MarkdownP,
  .cds--data-table-content,
  .WACWidget__MarkdownBlockquote,
  .WACWidget__MarkdownImg,
  .cds--list--ordered:not(.cds--list--nested),
  .cds--list--unordered:not(.cds--list--nested),
  .WACWidget__MarkdownPre {
    margin-block: 0;

    &:not(:first-child) {
      margin-block-start: layout.$spacing-05;
    }
  }

  .cds--list--unordered:not(.cds--list--nested),
  .cds--list--ordered:not(.cds--list--nested) {
    padding: 0;
    padding-block: layout.$spacing-03;
  }

  .WACWidget__MarkdownP {
    @include type.type-style("body-01");

    font-size: var(--cds-chat-BASE-font-size-med);
    line-height: var(--cds-chat-BASE-line-height-large);
  }

  .WACWidget__MarkdownBlockquote {
    border-inline-start: 4px solid var(--cds-chat-ACCENT-color);
    padding-inline-start: layout.$spacing-03;
  }

  pre,
  .WACWidget__MarkdownPre {
    @include type.type-style("code-02");

    overflow: auto hidden;
    padding: layout.$spacing-05;

    border: solid 1px theme.$chat-bubble-border;
    background-color: theme.$layer-02;
    white-space: pre-wrap;
  }

  .WACWidget__MarkdownImg {
    /* Make sure images in markdown don't overflow. */
    max-inline-size: 100%;
  }

  h1.WACWidget__MarkdownHeading,
  h2.WACWidget__MarkdownHeading,
  h3.WACWidget__MarkdownHeading,
  h4.WACWidget__MarkdownHeading,
  h5.WACWidget__MarkdownHeading,
  h6.WACWidget__MarkdownHeading {
    margin-block: 0;

    &:not(:first-child) {
      margin-block-start: layout.$spacing-06;
    }
  }

  h1.WACWidget__MarkdownHeading {
    @include type.type-style("heading-06");
  }

  h2.WACWidget__MarkdownHeading {
    @include type.type-style("heading-05");
  }

  h3.WACWidget__MarkdownHeading {
    @include type.type-style("heading-04");
  }

  h4.WACWidget__MarkdownHeading {
    @include type.type-style("heading-03");
  }

  h5.WACWidget__MarkdownHeading {
    @include type.type-style("heading-02");
  }

  h6.WACWidget__MarkdownHeading {
    @include type.type-style("heading-01");
  }

  .cds--data-table-content {
    overflow: auto hidden;
    overflow-wrap: normal;
    word-break: normal;
    word-wrap: normal;
  }
}

.WAC__sent-container {
  display: flex;
  justify-content: flex-end;
}

/* By default the message state is displayed next to the message. */
.WAC__sentAndMessageState-container {
  display: flex;
  flex-direction: row;
  justify-content: flex-end;
}

/* However some specific message states, like the message error state, are displayed below the message. */
.WAC__sentAndMessageState--belowMessage {
  display: flex;
  flex-direction: column;
  align-items: flex-end;

  .WAC__message-status {
    margin-inline: 0;
    padding-block-start: layout.$spacing-03;
  }
}

.WAC__message-status {
  display: flex;
  align-items: center;
  margin-inline: 8px;
}

.WAC__message-status .WAC__LoadingSpinner circle {
  stroke-width: 6;
}

@media screen and (prefers-reduced-motion: reduce) {
  .WAC__sent-container .WAC__message-status-file-success svg {
    animation: none;
    fill: var(--cds-chat-ACCENT-color);
  }
}

.WAC__sent-container .WAC__message-status-file-success svg {
  animation: motion.$duration-moderate-01 motion.motion(exit, expressive) 2s
    WACFadeOut forwards;
  fill: var(--cds-chat-ACCENT-color);
}

.WAC__received--loading,
.WAC__searchResult,
.WAC__sent--bubble {
  position: relative;
  opacity: 1;
  overflow-wrap: break-word;
  word-break: break-word;
  word-wrap: break-word;
}

.WAC__received--loading .WAC__received--inner {
  position: relative;
}

.WAC__sent--text > span {
  flex: 1;
}

.WAC__sent--text {
  display: flex;
}

svg.WAC__sent-fileIcon {
  margin-inline-end: 8px;
}

.WAC__sent {
  display: flex;
  flex-direction: column;
  inline-size: 100%;
}

.WAC__sent--bubble {
  align-self: end;
  padding: layout.$spacing-03 layout.$spacing-04;
  /* This is needed to fix a problem where Edge antialiases the edge when zoomed causing a gap with the arrow. See
   https:github.ibm.com/watson-engagement-advisor/wea-backlog/issues/28030 */
  border: solid 1px var(--cds-chat-SECONDARY-color);
  border-radius: var(--cds-chat-BASE-border-radius-med) 0
    var(--cds-chat-BASE-border-radius-med)
    var(--cds-chat-BASE-border-radius-med);
  background: var(--cds-chat-SECONDARY-color);
  color: var(--cds-chat-SECONDARY-color-text);
  font-size: var(--cds-chat-BASE-font-size-med);
  line-height: var(--cds-chat-BASE-line-height-med);
}

.WACContainer--render[dir="rtl"] .WAC__sent--bubble {
  border-radius: 0 var(--cds-chat-BASE-border-radius-med)
    var(--cds-chat-BASE-border-radius-med)
    var(--cds-chat-BASE-border-radius-med);
}

.WAC__received--options,
.WAC__received--suggestion {
  position: relative;
  overflow-wrap: break-word;
  word-break: break-word;
  word-wrap: break-word;
}

.WAC__received--iframePreviewCard {
  /* For some reason, without this property here, the preview card's width increases by 11 pixels if the url is too long.
   This property used to exist in the WAC__received class before Carbon AI chat 5.0 which would've prevented this issue. */
  overflow: hidden;
  inline-size: 100%;
}

.WACSearchMessage {
  font-size: var(--cds-chat-BASE-font-size-med);
  line-height: var(--cds-chat-BASE-line-height-large);
}

.WAC__bot-message .WAC__received--agentStatusMessage {
  color: theme.$text-helper;
  font-size: var(--cds-chat-BASE-font-size-med);
  padding-inline: layout.$spacing-05;
  text-align: center;
}

.WAC__bot-message
  .WAC__received--agentStatusMessage
  .WAC__received--textContent {
  display: flex;
  justify-content: center;
}

.WAC__bot-message .WAC__received--chatStatusMessage {
  color: theme.$text-secondary;
  font-size: var(--cds-chat-BASE-font-size-med);
}

.WAC__message--systemMessage {
  /* This is custom spacing and not from a token. */
  padding-block-start: 28px;
}

.WACMessage__AvatarLine {
  display: flex;

  /* This is custom spacing and not from a token. */
  padding-block-start: 28px;

  .WACMessage__Label {
    color: theme.$text-secondary;
    font-size: var(--cds-chat-BASE-font-size-small);
    line-height: var(--cds-chat-BASE-line-height-small);
  }

  .WACMessage__Avatar {
    display: flex;
    align-items: center;
    justify-content: center;
    block-size: layout.$spacing-07;
    inline-size: layout.$spacing-07;
  }

  .WACMessage__Avatar--bot {
    svg {
      block-size: 28px;
      inline-size: 28px;
    }
  }

  .WACImageWithFallback {
    display: flex;

    img,
    .WACIconHolder {
      border-radius: 14px;
      block-size: 28px;
      inline-size: 28px;

      svg {
        block-size: 16px;
        fill: theme.$icon-inverse;
        inline-size: 16px;
      }
    }
  }
}

.WAC__message--request .WACMessage__AvatarLine {
  justify-content: flex-end;
  padding-inline-end: layout.$spacing-05;

  .WACMessage__Label {
    padding-block-end: layout.$spacing-03;
    padding-inline-start: layout.$spacing-03;
  }
}

.WAC__message--response:not(
    .WAC__message--systemMessage
  ).WAC__message--agentMessage
  + .WAC__message--response:not(
    .WAC__message--systemMessage
  ).WAC__message--agentMessage,
.WAC__message--request + .WAC__message--request {
  padding-block-start: layout.$spacing-03;

  .WACMessage__AvatarLine {
    display: none;
  }

  .WAC__received--fromAgent,
  .WAC__sent--bubble {
    border-radius: var(--cds-chat-BASE-border-radius-med);
  }
}

.WAC__message--response:not(.WAC__message--agentMessage)
  .WACMessage__AvatarLine
  + .WAC__message--padding {
  padding-block-start: layout.$spacing-02;
}

.WAC__message--response .WACMessage__AvatarLine {
  padding-inline-start: layout.$spacing-05;

  .WACMessage__Label {
    padding-block: layout.$spacing-03;
    padding-inline: layout.$spacing-03;
  }
}

.WACMessage__Avatar--agent .WACImageWithFallback .WACIconHolder {
  background-color: theme.$chat-avatar-agent;
}

.WAC__received--fromAgent.WAC__received--text {
  padding: layout.$spacing-03 layout.$spacing-04;
  border: solid 1px theme.$chat-bubble-border;
  border-radius: 0 var(--cds-chat-BASE-border-radius-med)
    var(--cds-chat-BASE-border-radius-med)
    var(--cds-chat-BASE-border-radius-med);
  background-color: theme.$chat-bubble-agent;
  max-inline-size: 75%;
}

.WACContainer--render[dir="rtl"] .WAC__received--fromAgent.WAC__received--text {
  border-radius: var(--cds-chat-BASE-border-radius-med) 0
    var(--cds-chat-BASE-border-radius-med)
    var(--cds-chat-BASE-border-radius-med);
}

.WACMessage__Avatar--bot .WACImageWithFallback .WACIconHolder {
  background-color: theme.$chat-avatar-bot;
}

@keyframes WACMessageIn {
  0% {
    opacity: 0;
  }

  100% {
    opacity: 1;
  }
}

/* Views bigger than a small phone. */
.WAC--standardWidth,
.WAC--wideWidth {
  .WACMessage__AvatarLine
    + .WAC__message--padding
    .WAC__bot-message
    > div.WAC__received {
    margin-block-start: 0;
  }

  .WAC__message .WAC__received.WAC__received--agentStatusMessage {
    margin-inline: 0;
  }
}

/* Both the sent and received messages fill the same space within the chat. */
.WAC--wideWidth .WAC__message .WAC__received,
.WAC--standardWidth .WAC__message .WAC__received,
.WAC--wideWidth .WAC__message .WAC__sent-container,
.WAC--standardWidth .WAC__message .WAC__sent-container {
  /* Start = left padding + avatar + right padding. */
  margin-inline: calc(
      #{layout.$spacing-05} + #{layout.$spacing-07} + #{layout.$spacing-03}
    )
    layout.$spacing-05;
}
