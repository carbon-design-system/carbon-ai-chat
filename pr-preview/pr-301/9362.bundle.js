/*! For license information please see 9362.bundle.js.LICENSE.txt */
"use strict";(self.webpackChunk_carbon_ai_chat_examples_demo=self.webpackChunk_carbon_ai_chat_examples_demo||[]).push([[9362],{1400:function(e,t,s){s.d(t,{A:function(){return B},B:function(){return D},C:function(){return k},D:function(){return _},E:function(){return H},H:function(){return C},a:function(){return W},b:function(){return l},c:function(){return u},d:function(){return x},e:function(){return v},f:function(){return w},g:function(){return y},h:function(){return f},i:function(){return o},j:function(){return A},k:function(){return I},l:function(){return M},m:function(){return S},n:function(){return E},o:function(){return c},p:function(){return g},q:function(){return p},r:function(){return V},s:function(){return m},t:function(){return T},u:function(){return N},v:function(){return R},w:function(){return L},x:function(){return b},y:function(){return O},z:function(){return P}});var a=s(1536),n=s(171),r=s(307),i=s(4859);function o(e,t,s=(0,n.u)(n.U.LOCAL_MESSAGE)){return{item:{response_type:a.e.TEXT,...e.input},ui_state:{id:s,originalUserText:t,needsAnnouncement:!1},fullMessageID:e.id}}function c(e,t,s=!1,a=!1){const i={ui_state:{id:(0,r.t)(t.id,e)||(0,n.u)(n.U.LOCAL_MESSAGE),needsAnnouncement:!t.ui_state_internal?.from_history,disableFadeAnimation:a},item:e,fullMessageID:t.id};return s&&(i.ui_state.isWelcomeResponse=!0),i}function l(e){return function(e){const t=(0,r.J)(e);return{originalMessage:t,localMessage:c(e,t)}}({response_type:a.e.INLINE_ERROR,text:e})}function u(e,t,s,a,n){const{item:i}=e;if((0,r.L)(i))e.ui_state.gridLocalMessageItemIDs=i.rows.map(n=>n.cells.map(n=>{const r=[];return d("items",e,n.items,r,t,s,a,t=>h(e.item,t),!1),r}));else if((0,r.M)(i))e.ui_state.itemsLocalMessageItemIDs=[],d("items",e,i.items,e.ui_state.itemsLocalMessageItemIDs,t,s,a,e=>h(i,e),n);else{const o=i.body||i.panel?.body;if(o&&(e.ui_state.bodyLocalMessageItemIDs=[],d("body",e,o,e.ui_state.bodyLocalMessageItemIDs,t,s,a,e=>h(i,e),!(0,r.N)(i))),!n)return;const c=i.footer||i.panel?.footer;c&&(e.ui_state.footerLocalMessageItemIDs=[],d("footer",e,c,e.ui_state.footerLocalMessageItemIDs,t,s,a,e=>function(e,t){return!!(0,r.Q)(t)&&(!(0,r.N)(e)||!(0,r.N)(t))}(i,e),!(0,r.N)(i)))}}function d(e,t,s,a,n,o,l,d,h){s.forEach(s=>{if(d(s)){const e=c(s,n,!1,!0);a.push(e.ui_state.id),l.push(e),(0,r.q)(e.item)&&u(e,n,o,l,h)}else(0,i.b)(`The "${t.item.response_type}" response type does not support "${s.response_type}" in "${e}" array.`)})}function h(e,t){switch(e.response_type){case a.e.CARD:return!(0,r.P)(t)&&(0,r.O)(t);case a.e.CAROUSEL:return(0,r.P)(t);case a.e.BUTTON:return e.button_type===a.c.SHOW_PANEL&&(0,r.O)(t);case a.e.GRID:return!(0,r.P)(t)&&(0,r.O)(t);default:return!1}}const g="HA_SET_HUMAN_AGENT_AVAILABILITY",m="HA_SET_IS_CONNECTING",p="HA_SET_IS_RECONNECTING",S="HA_SET_HUMAN_AGENT_JOINED",f="HA_SET_HUMAN_AGENT_LEFT_CHAT",C="HA_END_CHAT",y="HA_UPDATE_CAPABILITIES",v="HA_UPDATE_FILE_UPLOAD_IN_PROGRESS",E="HA_SET_SHOW_SCREEN_SHARE_REQUEST",w="HA_SET_IS_SCREEN_SHARING",M="HA_SET_PERSISTED_STATE",I="HA_UPDATE_IS_SUSPENDED",A="HA_UPDATE_IS_TYPING";function T(e,t){return{type:m,isConnecting:e,localMessageID:t}}function b(e){return{type:p,isReconnecting:e}}function _(){return{type:f}}function R(){return{type:C}}function B(e){return{type:g,availability:e}}function D(e){return{type:S,responseUserProfile:e}}function P(e){return{type:y,capabilities:e}}function N(e){return{type:v,fileUploadInProgress:e}}function O(e){return{type:E,showRequest:e}}function L(e){return{type:w,isSharing:e}}function H(e){return{type:M,state:e}}function W(e){return{type:I,isSuspended:e}}function k(e){return{type:A,isTyping:e}}function x(e){return Object.freeze(e),Object.getOwnPropertyNames(e).forEach(t=>{!Object.prototype.hasOwnProperty.call(e,t)||null===e[t]||"object"!=typeof e[t]&&"function"!=typeof e[t]||Object.isFrozen(e[t])||x(e[t])}),e}function V(){let e,t;const s=new Promise((s,a)=>{e=s,t=a});return s.doResolve=t=>{s.isResolved=!0,s.isComplete=!0,e(t)},s.doReject=e=>{s.isRejected=!0,s.isComplete=!0,t(e)},s.isResolved=!1,s.isRejected=!1,s.isComplete=!1,s}},2022:function(e,t,s){s.d(t,{H:function(){return c}});var a=s(3696),n=s(5022),r=s(2865),i=s(8241);function o(e,t){const{brandColor:s,onClose:o,onRestart:c,onCloseAndRestart:l}=e,u=(0,n.d4)(e=>e.config.public.showRestartButton||e.config.public.headerConfig?.showRestartButton),d=(0,n.d4)(e=>e.persistedToBrowserStorage.chatState.homeScreenState.showBackToBot),h=(0,n.d4)(e=>e.headerDisplayName),g=(0,n.d4)(e=>e.customMenuOptions),m=(0,n.d4)(e=>e.theme.useAITheme),p=(0,a.useRef)();(0,a.useImperativeHandle)(t,()=>p.current);const S=!d,f=(0,a.useCallback)(e=>{const{handler:t}=g[e];t()},[g]),C=g?.map(e=>e.text);return a.createElement("div",{className:"WACHomeScreenHeader"},a.createElement(r.H,{ref:p,displayName:h,showCenter:!0,showRestartButton:u,hideCloseAndRestartButton:S,onClickRestart:c,onClickClose:o,onCloseAndRestart:l,overflowClicked:f,overflowItems:C,useAITheme:m,brandColor:s,testIdPrefix:i.O.HOME_SCREEN}))}const c=a.memo((0,a.forwardRef)(o))},4940:function(e,t,s){s.d(t,{B:function(){return l}});var a=s(4544),n=s(3696),r=s(5022),i=s(481),o=s(2865);function c({className:e,children:t,isOpen:s,hidePanelHeader:c,labelBackButton:l,title:u,hideBackButton:d,useAITheme:h,onClickCloseAndRestart:g,onClickRestart:m,testIdPrefix:p,...S},f){const C=(0,r.d4)(e=>e.config.public.headerConfig?.showRestartButton),y=(0,n.useRef)();return(0,n.useImperativeHandle)(f,()=>y.current),n.createElement(a,{active:s,focusTrapOptions:{clickOutsideDeactivates:!0,returnFocusOnDeactivate:!i.I,preventScroll:!0}},n.createElement("div",{className:e},!c&&n.createElement(o.H,{...S,ref:y,showRestartButton:C,onClickRestart:m,onCloseAndRestart:g,showBackButton:!d,labelBackButton:l,displayName:u,useAITheme:h,testIdPrefix:p,showCenter:!0}),n.createElement("div",{className:"WACPanelContent"},t)))}const l=n.memo(n.forwardRef(c))},9362:function(e,t,s){s.r(t),s.d(t,{AppContainer:function(){return es}});var a=s(253),n=s(3696),r=s(5285),i=s(8306),o=s(1122),c=s(8690),l=s(1517),u=s(9124),d=s(9708),h=s(6874),g=s(4859),m=s(3539),p=s(2685),S=s(2986),f=s(8710),C=s(1536),y=s(1400),v=s(5569),E=s(3167),w=s(4720),M=s(307),I=s(171),A=s(4308),T=s(481),b=s(2446),_=s(3582),R=(s(1108),s(4452)),B=s(5022),D=s(3744),P=s(158),N=s(7687),O=s(7161),L=s(4183),H=s(7201),W=s(1284),k=s(8241),x=s(2794),V=s(5550),U=s(4544),F=s(8213),$=s(9426),q=s(2022),G=s(4940),j=s(2865),Y=s(8325);function z(e){let t=e;return e?.starters?.buttons?.length&&(t={allow_return:!0,...e,starters:{...e.starters,buttons:e.starters.buttons.filter(e=>Boolean(e.label?.trim()))}},t?.starters?.buttons?.length||(t.starters.is_on=!1)),t}function Q(e,t,s){e.intl=(0,p.E)({locale:t,messages:s}),e.store.dispatch(l.a.setAppStateValue("languagePack",s)),e.store.dispatch(l.a.setAppStateValue("locale",t))}function K(e){const t=new Set,s={get(e,s){return t.has(s)||t.add(s),e[s]}};return new Proxy(e.writeableElements,s)}s(8142),s(3210),s(3192),s(619),s(7454),s(1200),s(8976),s(7190),s(8715),s(8761),s(4574),s(2436),s(2769),s(5222),s(9890),s(236),s(7826),s(1264),s(7323),s(3082),s(1357),s(4833),s(6073),s(7118),s(3967),s(644),s(6379),s(533),s(9e3),s(3777),s(9133),s(6608),s(712),s(9417),s(445),s(6677),s(1162),s(4776),s(3716);const X="0.4.0";var J;!function(e){e.TEXT_NOTIFICATION="text_notification"}(J||(J={}));const Z=[15e3,6e4],ee={config:{is_on:!0,mobile:{is_on:!0,title:"",time_to_expand:15e3,new_expand_time:!1,time_to_reduce:1e4,notification_type:J.TEXT_NOTIFICATION},desktop:{is_on:!0,title:"",new_expand_time:!1,time_to_expand:15e3,notification_type:J.TEXT_NOTIFICATION}}};(0,y.d)(ee);const te={title:null,hideBackButton:!1,hidePanelHeader:!1,disableAnimation:!1};(0,y.d)(te);const se={isOpen:!1,panelID:E.D,options:te};(0,y.d)(se);const ae={isOpen:!1,messageItem:null};(0,y.d)(ae);const ne={isOpen:!1,citationItem:null};(0,y.d)(ne);const re={activeTourStepItems:null};(0,y.d)(re);const ie={isOpen:!1,localMessageItem:null,isMessageForInput:!1};(0,y.d)(ie);const oe={launcher:!1,mainWindow:!1,tour:!1};(0,y.d)(oe);const ce={launcher:!0,mainWindow:!1,tour:!1};(0,y.d)(ce);const le={mainWindow:!0,launcher:!1,tour:!1};(0,y.d)(le);const ue={chatState:{version:X,disclaimersAccepted:{},homeScreenState:{isHomeScreenOpen:!1,showBackToBot:!1},hasSentNonWelcomeMessage:!1,persistedTourState:{activeTourID:null,activeTourCurrentStepIndex:null},humanAgentState:{isConnected:!1,isSuspended:!1,responseUserProfiles:{}}},launcherState:{wasLoadedFromBrowser:!1,version:X,viewState:oe,activeTour:!1,showUnreadIndicator:!1,mobileLauncherIsExtended:!1,mobileLauncherWasReduced:!1,mobileLauncherDisableBounce:!1,desktopLauncherIsExpanded:!1,desktopLauncherWasMinimized:!1,bounceTurn:1,hasSentNonWelcomeMessage:!1}};(0,y.d)(ue);const de={localMessageIDs:[],messageIDs:[],isTypingCounter:0,isLoadingCounter:0,isHydratingCounter:0,isScrollAnchored:!1};(0,y.d)(de);const he={allMessageItemsByID:{},allMessagesByID:{},botMessageState:{...de}};(0,y.d)(he);const ge={isConnecting:!1,isReconnecting:!1,numUnreadMessages:0,fileUploadInProgress:!1,showScreenShareRequest:!1,isScreenSharing:!1,isHumanAgentTyping:!1,inputState:{fieldVisible:!0,isReadonly:!1,files:[],allowFileUploads:!1,allowMultipleFileUploads:!1,allowedFileUploadTypes:null,stopStreamingButtonState:{currentStreamID:null,isVisible:!1,isDisabled:!1}}};(0,y.d)(ge);const me={carbonTheme:C.b.G10,useAITheme:!1,corners:C.a.ROUND};(0,y.d)(me);const pe={showFrame:!0,hasContentMaxWidth:!0};function Se(e,t){return{...e,botMessageState:{...e.botMessageState,...t}}}function fe(e,t,s){return void 0===s&&(s=e.persistedToBrowserStorage.chatState.homeScreenState.showBackToBot),{...e,persistedToBrowserStorage:{...e.persistedToBrowserStorage,chatState:{...e.persistedToBrowserStorage.chatState,homeScreenState:{...e.persistedToBrowserStorage.chatState.homeScreenState,isHomeScreenOpen:t,showBackToBot:s}}}}}function Ce(e,t,s,a){const n=e.allMessageItemsByID[t];return n?{...e,allMessageItemsByID:{...e.allMessageItemsByID,[t]:{...n,ui_state:{...n.ui_state,[s]:a}}}}:e}function ye(e,t){const s={...e,allMessagesByID:{...e.allMessagesByID,[t.id]:t}};return e.allMessagesByID[t.id]?s:Se(s,{messageIDs:[...e.botMessageState.messageIDs,t.id]})}(0,y.d)(pe);var ve="#ffffff",Ee="#161616";const we=4.5;function Me(e){if(7===e.length){const t=e.substring(1,3),s=e.substring(3,5),a=e.substring(5,7);return[parseInt(t,16),parseInt(s,16),parseInt(a,16)]}if(4===e.length){const t=e.substring(1,2),s=e.substring(2,3),a=e.substring(3,4);return[parseInt(t+t,16),parseInt(s+s,16),parseInt(a+a,16)]}return(0,g.b)(`Unsupported color code: "${e}"`),[0,0,0]}function Ie(e,t){const s=Me(e),a=Me(t),n=Ae(s),r=Ae(a);let i;return i=n>r?(n+.05)/(r+.05):(r+.05)/(n+.05),i}function Ae([e,t,s]){const a=e/255,n=t/255,r=s/255;return.2126*(a<=.03928?a/12.92:((a+.055)/1.055)**2.4)+.7152*(n<=.03928?n/12.92:((n+.055)/1.055)**2.4)+.0722*(r<=.03928?r/12.92:((r+.055)/1.055)**2.4)}function Te(e){return Ie(Ee,e)>=we?Ee:ve}function be(e,t){const s=A(e).hsl().object();return A({...s,l:s.l+t}).round().hex().toLowerCase()}const _e="--cds-",Re=/#([a-f0-9]{3}){1,2}\b/i,Be={"$chat-button":"#000000","$chat-button-text-hover":"#525252"},De={"$chat-button":"#ffffff","$chat-button-text-hover":"#f4f4f4"},Pe={white:{blue20:["$highlight"],blue60:["$background-brand","$interactive","$border-interactive","$button-primary","$button-tertiary","$icon-interactive","$focus"],blue60Hover:["$button-primary-hover","$button-tertiary-hover"],blue80:["$button-primary-active","$button-tertiary-active"]},g10:{blue20:["$highlight"],blue60:["$background-brand","$interactive","$border-interactive","$button-primary","$button-tertiary","$icon-interactive","$focus"],blue60Hover:["$button-primary-hover","$button-tertiary-hover"],blue80:["$button-primary-active","$button-tertiary-active"]},g90:{blue20:[],blue60:["$background-brand","$interactive","$border-interactive","$button-primary","$button-tertiary","$focus-inverse"],blue60Hover:["$button-primary-hover","$button-tertiary-hover"],blue80:["$button-primary-active","$highlight","$button-tertiary-active"]},g100:{blue20:[],blue60:["$background-brand","$interactive","$border-interactive","$button-primary","$button-tertiary","$focus-inverse"],blue60Hover:["$button-primary-hover","$button-tertiary-hover"],blue80:["$button-primary-active","$highlight","$button-tertiary-active"]}};function Ne(e,t,s){t.forEach(t=>{e[t]=s})}function Oe(e,t,s,a){s=s||C.b.G10,e=e||{};const n=function(e,t){let s={};return t||([C.b.G10,C.b.WHITE].includes(e)?s={...s,...Be}:[C.b.G90,C.b.G100].includes(e)&&(s={...s,...De})),s}(s,a=a||!1),r={...n,...e};Object.entries(r).forEach(([t,s])=>{t.startsWith("$")&&!s.match(Re)&&(console.warn(`${E.W} You tried to call "updateCSSVariables" with an invalid value for "${t}": "${e[t]}". You must use hexadecimal values for colors.`),delete r[t])});const i=function(e,t){const s={},a=e["BASE-primary-color"],n=e["BASE-secondary-color"],r=e["BASE-accent-color"];if(a){s["PRIMARY-color"]=a,s["PRIMARY-color-text"]=Te(a),s["PRIMARY-color-hover"]=be(a,-8),s["PRIMARY-color-active"]=be(a,-10);const e=r||"#0f62fe",n=t===C.b.G90||t===C.b.G100?ve:e;let i;i=Ie(a,n)>=we?n:n!==e&&Ie(a,e)>=we?e:n!==ve&&Ie(a,ve)>=we?ve:Ee,i!==n&&(s["PRIMARY-color-focus"]=i)}if(n?(s["SECONDARY-color"]=n,s["SECONDARY-color-text"]=Te(n)):t!==C.b.G90&&t!==C.b.G100||(s["SECONDARY-color"]=`var(${_e}layer-02)`,s["SECONDARY-color-text"]=`var(${_e}text-primary);`),r){const e=Pe[t],a=be(r,40),n=be(r,-8),i=be(r,-20);Ne(s,e.blue20,a),Ne(s,e.blue60,r),Ne(s,e.blue60Hover,n),Ne(s,e.blue80,i),s["LAUNCHER-color-background"]=r,s["LAUNCHER-color-background-hover"]=n,s["LAUNCHER-color-background-active"]=i,s["LAUNCHER-EXPANDED-MESSAGE-color-background"]=r,s["LAUNCHER-EXPANDED-MESSAGE-color-hover"]=n,s["LAUNCHER-EXPANDED-MESSAGE-color-active"]=i,s["ACCENT-color"]=r;const o=Me(r);s["ACCENT-color-r"]=o[0].toString(),s["ACCENT-color-g"]=o[1].toString(),s["ACCENT-color-b"]=o[2].toString(),s["ACCENT-color-ghost-text"]=r;const c=Te(r);s["ACCENT-color-text"]=c,s["ACCENT-color-background-hover"]=n,s["ACCENT-color-background-active"]=i,s["LAUNCHER-color-focus-border"]=c,s["LAUNCHER-color-avatar"]=c,s["LAUNCHER-EXPANDED-MESSAGE-color-text"]=c,s["LAUNCHER-EXPANDED-MESSAGE-color-focus-border"]=c,s["LAUNCHER-MOBILE-color-text"]=c,s["ACCENT-color-bw"]=c,s["ACCENT-color-bw-hover"]=be(c,-8),s["ACCENT-color-bw-active"]=be(c,-10),s["ACCENT-color-bw-inverse"]=c===Ee?ve:Ee,s["ACCENT-color-bw-gray"]=c===Ee?"#393939":"#f4f4f4",s["ACCENT-color-pastel"]=be(r,c===Ee?20:-15)}return s}(t||{},s);return Object.entries(i).forEach(([t,s])=>{""!==s&&void 0===e[t]&&(r[t]=s)}),r}function Le(e){let t;switch(e?.carbonTheme){case C.b.WHITE:t=w.C.WHITE;break;case C.b.G10:t=w.C.G10;break;case C.b.G90:t=w.C.G90;break;case C.b.G100:t=w.C.G100;break;default:t=w.C.G10}return e?.useAITheme&&(t+=" WAC--aiTheme"),t}function He(e,t){const{activeTour:s}=t.persistedToBrowserStorage.launcherState;return!(e.tour&&!s&&((0,g.b)("Error changing the view. The new view was supposed to show a tour however there is no active tour to show. Changing the view has been canceled."),1))}const We=new Set(Object.values(C.C)),ke=`[updateCSSVariables] The AI theme is enabled and only ${Object.values(C.C).join(", ")} can be updated.`;class xe{constructor(e){this.hydrating=!1,this.restarting=!1,this.alreadyHydrated=!1,this.chunkQueue=[],this.serviceManager=e}async hydrateChat(e,t,s){let a=!1;try{this.hydrationPromise||(this.hydrating=!0,this.hydrationPromise=this.doHydrateChat(e,t,s),a=!0),await this.hydrationPromise}finally{this.hydrating=!1}a&&await this.serviceManager.fire({type:m.B.CHAT_READY})}async doHydrateChat(e,t,s){let a;(0,g.e)("Hydrating Carbon AI chat",e,t,s);const{serviceManager:n}=this;n.store.dispatch(l.a.addIsHydratingCounter(1)),this.alreadyHydrated||(a=await this.serviceManager.historyService.loadHistory(),n.humanAgentService?((0,g.e)("Initializing the human agent service"),await n.humanAgentService.initialize()):(0,g.e)("No service desk integrations present"));const{config:r}=n.store.getState();if(a)n.store.dispatch(l.a.hydrateMessageHistory(a.messageHistory)),await this.createElementsForUserDefinedResponses(a.messageHistory),a.latestPanelLocalMessageItem&&this.openResponsePanel(a.latestPanelLocalMessageItem,!0);else if(!e){const e=n.store.getState();e.homeScreenConfig?.is_on?n.store.dispatch(l.a.setHomeScreenIsOpen(!0)):r.public.messaging?.skipWelcome||await n.actions.send((0,M.h)(),m.M.WELCOME_REQUEST,{returnBeforeStreaming:!0},!0)}if(e&&(n.store.dispatch(l.a.setHomeScreenIsOpen(!1)),await n.actions.send(e,t,s,!0)),n.store.dispatch(l.a.chatWasHydrated()),n.store.dispatch(l.a.addIsHydratingCounter(-1)),a){const e=(0,M.f)(a.messageHistory.botMessageState.localMessageIDs),t=a.messageHistory.allMessageItemsByID[e],s=a.messageHistory.allMessagesByID[t?.fullMessageID];!(0,M.j)(t)&&(0,M.a)(s)&&n.messageService.resendMessage(s,t.ui_state.id)}const i=r.public.serviceDesk.allowReconnect??!0;this.serviceManager?.humanAgentService?.handleHydration(i,Boolean(a)),this.alreadyHydrated=!0}getPublicWebChatState(){const e=this.serviceManager.store.getState(),{persistedToBrowserStorage:t}=e,{chatState:s,launcherState:a}=t;return{isConnectedWithHumanAgent:s.humanAgentState.isConnected,isWebChatOpen:a.viewState.mainWindow,isConnectingWithHumanAgent:e.humanAgentState.isConnecting,isHomeScreenOpen:s.homeScreenState.isHomeScreenOpen,isDebugEnabled:(0,g.f)(),hasUserSentMessage:s.hasSentNonWelcomeMessage,isTourActive:a.activeTour,viewState:{...a.viewState},serviceDesk:{isConnected:s.humanAgentState.isConnected,isConnecting:e.humanAgentState.isConnecting,isSuspended:s.humanAgentState.isSuspended??!1},locale:this.serviceManager.store.getState().locale,intl:this.serviceManager.intl}}async sendWithCatch(e,t,s={},a=!1){try{await this.send(e,t,s,a)}catch(e){(0,g.b)("An error occurred sending the message",e)}}async send(e,t,s={},a=!1){const n="string"==typeof e?(0,M.k)(e):e;this.serviceManager.store.getState().persistedToBrowserStorage.chatState.homeScreenState.isHomeScreenOpen&&this.serviceManager.store.dispatch(l.a.setHomeScreenIsOpen(!1)),this.serviceManager.store.getState().responsePanelState.isOpen&&this.serviceManager.store.dispatch(l.a.setResponsePanelIsOpen(!1)),this.hydrationPromise||a?(a||await this.hydrationPromise,await this.doSend(n,t,s)):await this.hydrateChat(n,t,s)}async doSend(e,t,s={}){const{store:a}=this.serviceManager;(0,M.l)(e);const n=e.history?.label||e.input.text;s.silent&&(e.history.silent=!0);const r=(0,y.i)(e,n);e.history.silent?a.dispatch(l.a.addMessage(e)):a.dispatch(l.a.addLocalMessageItem(r,e,!0)),s.setValueSelectedForMessageID&&a.dispatch(l.a.messageSetOptionSelected(s.setValueSelectedForMessageID,e)),(0,y.d)(e),await this.serviceManager.messageService.send((0,c.A)(e),t,r.ui_state.id,s)}async receive(e,t=!1,s,a){const{restartCount:n}=this.serviceManager;e.id||(e.id=(0,I.u)(I.U.MESSAGE));const r={type:m.B.PRE_RECEIVE,data:e};if(await this.serviceManager.fire(r),n!==this.serviceManager.restartCount)return;if(t||this.serviceManager.store.dispatch(l.a.updateHasSentNonWelcomeMessage(!0)),n!==this.serviceManager.restartCount)return;const{languagePack:i}=this.serviceManager.store.getState();if((0,M.b)(e))this.processMessageResponse(e,t,s,a).catch(e=>{(0,g.b)("Error processing the message response",e)});else{const t=(0,M.m)(i.errors_singleMessage,e.thread_id,C.e.INLINE_ERROR);this.receive(t,!1)}(0,y.d)(e),await this.serviceManager.fire({type:m.B.RECEIVE,data:e})}async removeMessages(e){this.serviceManager.store.dispatch(l.a.removeMessages(e))}async insertHistory(e){const t=this.serviceManager.mainWindow?.getMessagesScrollBottom(),s=this.serviceManager.store.getState(),a={notes:[{body:e}]},n=await this.serviceManager.historyService.loadHistory(a),r={allMessageItemsByID:s.allMessageItemsByID,allMessagesByID:s.allMessagesByID,botMessageState:s.botMessageState},i=(0,o.A)({},n.messageHistory,r);i.botMessageState.messageIDs=[...n.messageHistory.botMessageState.messageIDs,...r.botMessageState.messageIDs],i.botMessageState.localMessageIDs=[...n.messageHistory.botMessageState.localMessageIDs,...r.botMessageState.localMessageIDs],this.serviceManager.store.dispatch(l.a.hydrateMessageHistory(i)),await this.createElementsForUserDefinedResponses(n.messageHistory),this.serviceManager.mainWindow?.doAutoScroll({scrollToBottom:t})}async receiveChunk(e,t,s={}){const a=(0,y.r)();return this.chunkQueue.push({chunk:e,messageID:t,options:s,chunkPromise:a}),1===this.chunkQueue.length&&this.processChunkQueue(),a}async processChunkQueue(){const{chunk:e,options:t,chunkPromise:s}=this.chunkQueue[0];let{messageID:a}=this.chunkQueue[0];const n=(0,M.n)(e),r=(0,M.o)(e),{store:i}=this.serviceManager,o=i.getState().botInputState.stopStreamingButtonState.isVisible;if(r&&e.partial_item.streaming_metadata.cancellable&&!o&&i.dispatch(l.a.setStopStreamingButtonVisible(!0)),n||r){a||(a=e.streaming_metadata.response_id),i.getState().allMessagesByID[a]||i.dispatch(l.a.streamingStart(a));const s=e.partial_item||e.complete_item;if(i.dispatch(l.a.streamingAddChunk(a,s,n,t.disableFadeAnimation??!0)),e.partial_response?.history){if(Object.keys(e.partial_response).length>1)throw new Error('The partial_response object only supports the "history" property.');i.dispatch(l.a.streamingMergeHistory(a,e.partial_response?.history))}await this.handleUserDefinedResponseItemsChunk(a,e,s)}else(0,M.p)(e)&&this.receive(e.final_response,t.isLatestWelcomeNode,null,{disableFadeAnimation:!0});(n||(0,M.p)(e))&&o&&(i.dispatch(l.a.setStopStreamingButtonDisabled(!1)),i.dispatch(l.a.setStopStreamingButtonVisible(!1))),this.chunkQueue.shift(),s.doResolve(),this.chunkQueue[0]&&this.processChunkQueue()}getOrCreateUserDefinedElement(e){let t=this.serviceManager.userDefinedElementRegistry.get(e);return t||(t={element:document.createElement("div"),slotName:`slot-user-defined-${(0,I.u)()}`},t.element.setAttribute("slot",t.slotName),this.serviceManager.userDefinedElementRegistry.set(e,t)),t}async handleUserDefinedResponseItems(e,t){if((0,M.r)(e.item)){let s,a;e.item.user_defined?.silent||({element:s,slotName:a}=this.getOrCreateUserDefinedElement(e.ui_state.id));const n={type:m.B.USER_DEFINED_RESPONSE,data:{message:e.item,fullMessage:t,element:s,slot:a}};await this.serviceManager.fire(n)}else if((0,M.q)(e.item)){const{itemsLocalMessageItemIDs:s,bodyLocalMessageItemIDs:a,footerLocalMessageItemIDs:n,gridLocalMessageItemIDs:r}=e.ui_state,{allMessageItemsByID:i}=this.serviceManager.store.getState(),o=e=>{const s=i[e];return this.handleUserDefinedResponseItems(s,t)};r?.length&&await(0,M.s)(r,e=>(0,M.s)(e,e=>(0,M.s)(e,e=>o(e)))),s?.length&&await(0,M.s)(s,o),a?.length&&await(0,M.s)(a,o),n?.length&&await(0,M.s)(n,o)}}async handleUserDefinedResponseItemsChunk(e,t,s){if((0,M.r)(s)){const a=(0,M.t)(e,s);let n,r;s.user_defined?.silent||({element:n,slotName:r}=this.getOrCreateUserDefinedElement(a));const i={type:m.B.CHUNK_USER_DEFINED_RESPONSE,data:{messageItem:s,chunk:t,element:n,slot:r}};await this.serviceManager.fire(i)}}async processMessageResponse(e,t,s,a={}){const{store:n}=this.serviceManager,{config:r}=n.getState(),i=this.serviceManager.restartCount,o=e.output.generic;e.request_id=s?.id,(0,M.l)(e),n.dispatch(l.a.addMessage(e));let c=null;for(let s=0;s<o.length&&i===this.serviceManager.restartCount;s++){const u=o[s];if(u){const s=(0,M.u)(u),o=(0,M.i)(u),d=(0,M.v)(u),h=(0,y.o)(u,e,t,a.disableFadeAnimation);if(d&&(a.skipTourCard||u.user_defined?.skip_card)){const e=a.skipTourCard?m.a.START_TOUR_METHOD:m.a.SKIP_CARD,{viewState:t}=n.getState().persistedToBrowserStorage.launcherState;if(t.mainWindow){const t=a.skipTourCard?m.d.CALLED_START_TOUR:m.d.TOUR_SKIP_CARD;this.startTour(h,e,{mainWindowCloseReason:t}).catch(e=>{(0,g.b)("Error starting the tour",e)})}else{const t=a.skipTourCard?m.V.CALLED_START_TOUR:m.V.TOUR_SKIP_CARD;this.startTour(h,e,{viewChangeReason:t}).catch(e=>{(0,g.b)("Error starting the tour",e)})}}else!d&&a.skipTourCard&&(0,g.b)("The message response received was not a tour, so the tour card was not skipped nor was a tour started by the startTour() call.");const p=[];if((0,y.c)(h,e,!1,p,!0),n.dispatch(l.a.addNestedMessages(p)),o&&(0,M.b)(e)){n.dispatch(l.a.addIsTypingCounter(1));const t={};if(!(0,M.w)(r)){const e='Web chat received a "connect_to_agent" message but there is no service desk configured. Check your chat configuration.';this.errorOccurred({errorType:C.O.INTEGRATION_ERROR,message:e}),n.dispatch(l.a.setMessageUIStateInternalProperty(h.fullMessageID,"agent_no_service_desk",!0)),t.ui_state_internal.agent_no_service_desk=!0}const s=await(this.serviceManager.humanAgentService?.checkAreAnyHumanAgentsOnline(e));if(i===this.serviceManager.restartCount){n.dispatch(l.a.setMessageUIStateInternalProperty(h.fullMessageID,"agent_availability",s)),t.ui_state_internal=t.ui_state_internal||{},t.ui_state_internal.agent_availability=s;let a=!1;r.public.serviceDesk?.skipConnectHumanAgentCard&&(a=!0),n.dispatch(l.a.addIsTypingCounter(-1)),a&&s===v.H.ONLINE&&this.serviceManager.humanAgentService.startChat(h,e)}}if(s){const e=(0,M.x)(u);e&&n.dispatch(l.a.addIsTypingCounter(1)),await(0,g.s)(u.time),e&&i===this.serviceManager.restartCount&&n.dispatch(l.a.addIsTypingCounter(-1))}else await this.handleUserDefinedResponseItems(h,e),h.item.user_defined?.silent||i!==this.serviceManager.restartCount||(this.serviceManager.store.dispatch(l.a.addLocalMessageItem(h,e,!1,c)),c=h.ui_state.id)}}}openResponsePanel(e,t){this.serviceManager.store.dispatch(l.a.setResponsePanelContent(e,t)),this.serviceManager.store.dispatch(l.a.setResponsePanelIsOpen(!0))}async insertLocalMessageResponse(e){e.id=(0,I.u)(I.U.MESSAGE),await this.processMessageResponse(e,!1,null,{})}updateLanguagePack(e){const{languagePack:t,locale:s}=this.serviceManager.store.getState(),a={...t,...e};Q(this.serviceManager,s,a)}addNotification(e){this.serviceManager.store.dispatch(l.a.addNotification(e))}removeNotification(e){this.serviceManager.store.dispatch(l.a.removeNotifications({groupID:e}))}removeAllNotifications(){this.serviceManager.store.dispatch(l.a.removeAllNotifications())}updateCSSVariables(e,t={}){const{store:s}=this.serviceManager,{theme:a}=s.getState(),{carbonTheme:n,useAITheme:r}=a;if(r){const s=e;e={},t={},s&&Object.entries(s).forEach(([t])=>{We.has(t)?e[t]=s[t]:(0,g.c)(ke)})}else e={...e},t={...t};const i=Oe(e,t,n,r);s.dispatch(l.a.updateCSSVariables(i,e,t))}updateBotName(e){this.serviceManager.store.dispatch(l.a.updateBotName(e))}updateMainHeaderTitle(e){this.serviceManager.store.dispatch(l.a.updateMainHeaderTitle(e))}updateBotAvatarURL(e){this.serviceManager.store.dispatch(l.a.updateBotAvatarURL(e))}updateHomeScreenConfig(e){this.serviceManager.store.dispatch(l.a.updateHomeScreenConfig(e))}updateLauncherConfig(e){this.serviceManager.store.dispatch(l.a.updateLauncherConfig(e))}async changeView(e,t,s=!0,n=!1){const{store:r}=this.serviceManager,{viewState:i}=r.getState().persistedToBrowserStorage.launcherState;let o=function(e,t){const{viewState:s}=t.persistedToBrowserStorage.launcherState;let a;return a="string"==typeof e?{...oe,[e]:!0}:{...s,...e},a}(e,r.getState());return He(o,r.getState())?((0,a.A)(o,i)&&!n||(await this.fireViewChangeEventsAndChangeView(o,t),o=r.getState().persistedToBrowserStorage.launcherState.viewState,s&&(o.mainWindow||o.tour)&&!r.getState().isHydrated&&this.hydrateChat().catch(e=>{(0,g.b)("Error hydrating the chat",e)})),o):i}async fireViewChangeEventsAndChangeView(e,t){const{store:s}=this.serviceManager;if(s.getState().viewChanging)throw new Error("The view may not be changed while a view change event is already running. Please make sure to resolve any promises from these events.");s.dispatch(l.a.setViewChanging(!0));const{viewState:a}=s.getState().persistedToBrowserStorage.launcherState,{viewChangeReason:n}=t,r=(0,y.d)(a);try{const t={type:m.B.VIEW_PRE_CHANGE,reason:n,oldViewState:r,newViewState:e,cancelViewChange:!1};if(await this.serviceManager.fire(t),t.cancelViewChange)return void(0,g.e)("The view changing was cancelled by a view:pre:change event.");if(!He(t.newViewState,s.getState()))return;e=t.newViewState,s.dispatch(l.a.setViewState((0,y.d)(e)));const a={type:m.B.VIEW_CHANGE,reason:n,oldViewState:r,newViewState:e,cancelViewChange:!1};if(await this.serviceManager.fire(a),a.cancelViewChange)return s.dispatch(l.a.setViewState(r)),void(0,g.e)("The view changing was cancelled by a view:change event.");if(!He(a.newViewState,s.getState()))return void s.dispatch(l.a.setViewState(r));e=a.newViewState,s.dispatch(l.a.setViewState((0,y.d)(e)))}finally{s.dispatch(l.a.setViewChanging(!1))}}async startTour(e,t,s){this.serviceManager.store.dispatch(l.a.setTourData(e.fullMessageID)),(await this.changeView(C.V.TOUR,s)).tour&&(await this.serviceManager.fire({type:m.B.TOUR_START,reason:t}),await this.serviceManager.fire({type:m.B.TOUR_STEP,step:this.serviceManager.store.getState().tourState.activeTourStepItems[0]}))}async endTour(e){const{viewState:t}=this.serviceManager.store.getState().persistedToBrowserStorage.launcherState;let s=t;return t.tour&&(s=await this.changeView(C.V.LAUNCHER,e)),!s.tour&&(this.serviceManager.store.dispatch(l.a.clearTourData()),!0)}goToSpecificTourStep(e){const{activeTourStepItems:t}=this.serviceManager.store.getState().tourState,s=t.findIndex(t=>t.step_id===e);s?this.changeStepInTour({newStepIndex:s}):(0,g.b)(`No step with the id "${e}" was found within the current tour. As a result, goToTourStep() did not change the current tour step.`)}async changeStepInTour(e){const{store:t}=this.serviceManager,{activeTourStepItems:s}=t.getState().tourState,{activeTourCurrentStepIndex:a}=t.getState().persistedToBrowserStorage.chatState.persistedTourState;let{newStepIndex:n}=e;e.nextStep?n=a+1:e.previousStep&&(n=a-1),t.dispatch(l.a.changeStepInTour(n));const r=t.getState().persistedToBrowserStorage.chatState.persistedTourState.activeTourCurrentStepIndex;r===n?await this.serviceManager.fire({type:m.B.TOUR_STEP,step:s[r]}):(0,g.c)("The tour tried to change to a step that was out of bounds for the step array, so no step change was made.")}errorOccurred(e){(0,g.b)("An error has occurred",e),e.catastrophicErrorType&&this.serviceManager.store.dispatch(l.a.setAppStateValue("catastrophicErrorType",e.catastrophicErrorType)),(0,g.g)(this.serviceManager.additionalChatParameters.onError,e)}async restartConversation(e={}){const{skipHydration:t=!1,endHumanAgentConversation:s=!0,fireEvents:a=!0}=e;if((0,g.e)("Restarting conversation"),this.restarting)(0,g.c)("You cannot restart a conversation while a previous restart is still pending.");else{this.restarting=!0;try{const{serviceManager:e}=this,{store:n}=e;a&&await e.fire({type:m.B.PRE_RESTART_CONVERSATION}),e.restartCount++,this.hydrating&&await this.hydrationPromise;const r=n.getState(),{persistedToBrowserStorage:i}=r,{viewState:o}=i.launcherState,{isConnecting:c}=r.humanAgentState,{isConnected:u}=r.persistedToBrowserStorage.chatState.humanAgentState;(u||c)&&s&&await e.humanAgentService.endChat(!0,!1,!1),o.tour&&await this.serviceManager.actions.changeView(C.V.MAIN_WINDOW,{mainWindowOpenReason:m.b.CALLED_RESTART_CONVERSATION},!1),this.serviceManager.instance.updateAssistantInputFieldVisibility(!0),this.serviceManager.messageService.cancelAllMessageRequests(),n.dispatch(l.a.restartConversation()),t||(this.hydrationPromise=null),a&&await e.fire({type:m.B.RESTART_CONVERSATION}),this.hydrating&&await this.hydrationPromise,t||e.store.getState().isHydrated?n.dispatch(l.a.chatWasHydrated()):(this.hydrationPromise=null,n.getState().persistedToBrowserStorage.launcherState.viewState.mainWindow&&await e.actions.hydrateChat())}finally{this.restarting=!1}}}async destroySession(e){const{store:t}=this.serviceManager,{persistedToBrowserStorage:s}=t.getState(),a=s.launcherState.viewState,n=(0,c.A)(ue);e?(n.launcherState.viewState=a,a.tour&&(n.launcherState.viewState={...a,tour:!1,mainWindow:!0})):n.launcherState.viewState=ce,this.serviceManager.messageService.cancelAllMessageRequests(),this.serviceManager.userSessionStorageService.clearLauncherSession(),this.serviceManager.userSessionStorageService.clearChatSession(),this.serviceManager.store.dispatch(l.a.setAppStateValue("persistedToBrowserStorage",n))}agentEndConversation(e){return this.serviceManager.humanAgentService.endChat(e)}agentUpdateIsSuspended(e){this.serviceManager.store.dispatch((0,y.a)(e))}async createElementsForUserDefinedResponses(e){await(0,M.s)(Object.values(e.allMessageItemsByID),t=>{const s=e.allMessagesByID[t.fullMessageID];return this.handleUserDefinedResponseItems(t,s)})}}const Ve="The event handler is not a function.";class Ue{constructor(){this.handlersByType=new Map,this.eventsTypesRunning=new Set,this.eventsRunningCount=0}async fire(e,t){Fe("Before fire",e);const{type:s}=e;if(!s)throw new Error(`Attempted to fire an event with no type! ${JSON.stringify(e)}`);if(this.eventsTypesRunning.has(s))throw new Error(`An event of type ${s} is already running. Please make sure that you have resolved the Promises for any earlier events that were fired.`);try{this.eventsRunningCount++;try{this.eventsTypesRunning.add(s);const a=this.handlersByType.get(s);if(a&&a.length){const n=a.slice();await(0,M.s)(n,function(a){const n=a(e,t);return!n||n instanceof Promise||(0,g.c)(`An event handler for event ${s} returned a non-promise. This might be a mistake.`,n),n})}}finally{this.eventsTypesRunning.delete(s)}}finally{this.eventsRunningCount--,this.waitForEmptyPromise&&0===this.eventsRunningCount&&this.waitForEmptyPromise.doResolve()}Fe("After fire",e)}fireSync(e,t){Fe("Before fire",e);const{type:s}=e,a=this.handlersByType.get(s);a&&a.length&&a.slice().forEach(s=>s(e,t)),Fe("After fire",e)}async waitForEmpty(){0!==this.eventsRunningCount&&(this.waitForEmptyPromise||(this.waitForEmptyPromise=(0,y.r)()),await this.waitForEmptyPromise,this.waitForEmptyPromise=null)}on(e){return(0,M.y)(e).forEach(({type:e,handler:t})=>{if(!e)throw new Error(`Attempted to listen to an event with no type: "${e}"!`);if("function"==typeof t){this.handlersByType.has(e)||this.handlersByType.set(e,[]);const s=this.handlersByType.get(e);(0,g.h)(`[EventBus] Adding ${e} event handler`,t),s.push(t)}else(0,g.b)(Ve,t)}),this}off(e){return(0,M.y)(e).forEach(({type:e,handler:t})=>{const s=this.handlersByType.get(e);if(s)if(t){const a=s.indexOf(t);if(-1!==a){const t=s.splice(a,1);(0,g.h)(`[EventBus] Removing ${e} event handlers`,t)}}else(0,g.h)(`[EventBus] Removing all ${e} event handlers`),this.handlersByType.set(e,[])}),this}once(e){return(0,M.y)(e).forEach(({type:e,handler:t})=>{if("function"==typeof t){const s=(a,n)=>(this.off({type:e,handler:s}),t(a,n));this.on({type:e,handler:s})}else(0,g.b)(Ve,t)}),this}logListeners(){this.handlersByType.forEach((e,t)=>{console.group(`Event ${t} (${e.length})`),e.forEach(e=>{(0,g.j)("Listener",e)}),console.groupEnd()})}clear(){return this.handlersByType.clear(),this}}function Fe(e,t){if((0,g.f)()){const s=(0,c.A)(t);(0,g.e)(`[EventBus] ${e}`,s)}}function $e(e){const t={open(t=te){const{store:s}=e;s.dispatch(l.a.setCustomPanelConfigOptions(t)),s.dispatch(l.a.setCustomPanelOpen(!0))},close(){e.store.dispatch(l.a.setCustomPanelOpen(!1))}};return Object.freeze(t)}class qe{constructor(e){this.serviceManager=e}async loadHistory(e){const t=this.serviceManager.store.getState(),{config:s,persistedToBrowserStorage:a}=t,n=s.public,{viewState:r}=a.launcherState;try{let t;if(e)t=e;else if(n.messaging?.customLoadHistory){t={notes:[{body:await n.messaging.customLoadHistory(this.serviceManager.instance)}]}}if(t){const e=t?.notes;return async function(e,t){const s={},a={},n={serviceManager:t,allMessages:[],allMessagesByID:a,allLocalMessagesByID:s,threadMessagesByThreadID:{},responsesByRequestID:{},relatedMessageByID:{},localMessagesByOriginalMessageID:{},lastThreadID:null,loadedHistory:{messageHistory:{allMessageItemsByID:s,allMessagesByID:a,botMessageState:null},latestTransferToHumanAgentResponse:null,latestPanelLocalMessageItem:null}};return await async function(e,t){const{allMessages:s,allMessagesByID:a,responsesByRequestID:n,relatedMessageByID:r,serviceManager:i,localMessagesByOriginalMessageID:o}=t;if(!e?.length)return;e.forEach(e=>{e.body.forEach(e=>{const{message:s}=e;(0,M.B)(s)||!(0,M.a)(s)&&!(0,M.b)(s)||function(e,t,s){e.history=e.history||{},e.ui_state_internal=e.ui_state_internal||{},e.ui_state_internal.from_history=!0,e.history.timestamp=new Date(s.time).getTime(),e.thread_id!==M.T&&(t.lastThreadID=e.thread_id),t.allMessagesByID[e.id]=e,t.allMessages.push(e)}(s,t,e)})});for(let e=s.length-1;e>=0;e--){const t=s[e];t.history?.file_upload_status===C.F.UPLOADING&&(t.history.file_upload_status=C.F.COMPLETE,t.history.error_state=v.M.FAILED),(0,M.b)(t)&&t.history.silent?(s.splice(e,1),delete a[t.id]):(o[t.id]=[],(0,M.b)(t)&&t.request_id&&(n[t.request_id]=t),t.history.related_message_id&&(r[t.history.related_message_id]=t))}if(!s.length)return;Object.freeze(s);const c={type:m.B.HISTORY_BEGIN,messages:s};await i.eventBus.fire(c,i.instance),s.forEach(y.d),await i.eventBus.fire({type:m.B.HISTORY_END,messages:s},i.instance)}(e,n),n.allMessages.length?(function(e){const{allMessages:t,allLocalMessagesByID:s,localMessagesByOriginalMessageID:a}=e;t.forEach(t=>{if((0,M.a)(t)){if(!t.history?.silent){const e=t.history?.label||t.input.text,n=(0,y.i)(t,e);a[t.id].push(n),s[n.ui_state.id]=n}}else{const n=function(e){return(0,M.b)(e)?e.output.generic:null}(t);n?.length&&n.forEach(n=>{if(!(0,M.u)(n)){const r=(0,y.o)(n,t,!1);if(a[t.id].push(r),s[r.ui_state.id]=r,(0,M.q)(r.item)){const s=[];(0,y.c)(r,t,!0,s,!0),s.forEach(t=>{const s=t.ui_state.id;e.loadedHistory.messageHistory.allMessageItemsByID[s]=t})}}})}!function(e,t){const{threadMessagesByThreadID:s}=t;let a=s[M.T];a||(a=[],s[M.T]=a),a.push(e)}(t,e)})}(n),function(e){const{loadedHistory:t,threadMessagesByThreadID:s,localMessagesByOriginalMessageID:a}=e;t.messageHistory.botMessageState=function(e,t){const s=[],a=[];return e&&e.forEach(e=>{a.push(e.id),t[e.id].forEach(e=>{s.push(e.ui_state.id)})}),{...de,localMessageIDs:s,messageIDs:a}}(s[M.T],a)}(n),function(e){const{responsesByRequestID:t,threadMessagesByThreadID:s,localMessagesByOriginalMessageID:a}=e,n=s[M.T],r=(0,M.z)(n,e=>(0,M.a)(e)&&e.history.is_welcome_request);if(r){const e=t[r.id];e&&a[e.id].forEach(e=>{e.ui_state.isWelcomeResponse=!0})}}(n),function({allMessages:e,relatedMessageByID:t,localMessagesByOriginalMessageID:s}){e.forEach(e=>{(0,M.b)(e)&&s[e.id].forEach(s=>{if((0,M.c)(s.item)){const a=t[e.id];(0,M.a)(a)&&(s.ui_state.optionSelected=a)}else if((0,M.A)(s)){const a=t[e.id];(0,M.a)(a)&&(s.ui_state.originalUserText=a.history.label)}})})}(n),n.loadedHistory):null}(e,this.serviceManager)}r.tour&&(await this.serviceManager.actions.changeView(C.V.MAIN_WINDOW,{mainWindowOpenReason:m.b.SESSION_HISTORY},!1),this.serviceManager.store.dispatch(l.a.clearTourData()))}catch(e){(0,g.b)("An error occurred while attempting to load the conversation history",e)}return null}}class Ge{start(e,t,s,a,n){this.hasExceededMaxSilentLoading=!1,this.onEnd=t,this.onSilentLoading=setTimeout(()=>{this.hasExceededMaxSilentLoading=!0,e()},a),this.onMaxAttempt=setTimeout(()=>{s()},n)}end(){this.onMaxAttempt&&clearTimeout(this.onMaxAttempt),this.onSilentLoading&&clearTimeout(this.onSilentLoading),this.onEnd&&this.onEnd(this.hasExceededMaxSilentLoading),this.hasExceededMaxSilentLoading=null,this.onEnd=null}}const je=[1e3,3e3,5e3];var Ye;!function(e){e[e.SILENT=1]="SILENT",e[e.VISIBLE=2]="VISIBLE"}(Ye||(Ye={}));class ze{constructor(e,t){this.pendingLocale=!1,this.localeIsExplicit=!1,this.serviceManager=e,this.messageLoadingManager=new Ge,this.queue={waiting:[],current:null};const s=t.messaging?.messageTimeoutSecs;this.timeoutMS=s?1e3*s:15e4}async processSuccess(e,t){const{requestOptions:s,isProcessed:a}=e,n=Boolean(e.message.history.is_welcome_request);if(a)return;this.setMessageErrorState(e,v.M.NONE);const{message:r}=e;t&&(r.input.message_type!==C.d.EVENT&&(n||this.messageLoadingManager.end(),t.history=t.history||{},t.history.timestamp=t.history.timestamp||Date.now(),e.trackData.lastRequestTime=Date.now()-e.timeLastRequest,e.trackData.totalRequestTime=Date.now()-e.timeFirstRequest,await this.serviceManager.actions.receive(t,n,r,s)),this.messageLoadingManager.end()),e.isProcessed||(e.sendMessagePromise.doResolve(),e.isProcessed=!0,this.moveToNextQueueItem())}addErrorMessage(){const{store:e}=this.serviceManager,t=e.getState().languagePack.errors_singleMessage,{originalMessage:s,localMessage:a}=(0,y.b)(t);e.dispatch(l.a.addLocalMessageItem(a,s,!0))}async resendMessage(e,t){await this.send((0,c.A)(e),m.M.HYDRATE_RESEND,t,{skipQueue:!0,silent:!0})}sendToAssistantAndUpdateErrorState(e){e.isProcessed||(this.sendToAssistant(e),(6e3>Date.now()-e.timeFirstRequest?Ye.SILENT:Ye.VISIBLE)===Ye.VISIBLE&&(this.setMessageErrorState(e,v.M.RETRYING),this.queue.waiting.forEach(e=>{this.setMessageErrorState(e,v.M.WAITING)})))}async processError(e,t,s){const{message:a,timeFirstRequest:n,timeLastRequest:r,tryCount:i,isProcessed:o,trackData:c,requestOptions:l}=e,u=a.history.is_welcome_request,d=Date.now()-n,h=this.timeoutMS>d&&i<je.length;if(!o)if(c.lastRequestTime=Date.now()-r,c.totalRequestTime=Date.now()-n,h&&s){c.numErrors++;const t=je[e.tryCount++];setTimeout(()=>{this.sendToAssistantAndUpdateErrorState(e)},t)}else{let s=!1;u?s=!0:l.silent&&this.addErrorMessage(),this.serviceManager.actions.errorOccurred({errorType:C.O.MESSAGE_COMMUNICATION,message:"An error occurred sending a message",otherData:t,catastrophicErrorType:s}),this.rejectFinalErrorOnMessage(e,t)}}rejectFinalErrorOnMessage(e,t="An undefined error occurred trying to send your message."){const{sendMessagePromise:s}=e;this.setMessageErrorState(e,v.M.FAILED);const{message:a}=e;e!==this.queue.current||a.input.message_type===C.d.EVENT||a.history.is_welcome_request||this.messageLoadingManager.end(),s.doReject(new Error(t)),e.isProcessed=!0,e===this.queue.current&&this.moveToNextQueueItem()}async sendToAssistant(e){const{store:t}=this.serviceManager,s=t.getState(),{customSendMessage:a}=s.config.public.messaging;if(e.timeLastRequest=Date.now(),!e.isProcessed)try{const s=(0,c.A)(e.message);e.message=s,t.dispatch(l.a.updateMessage(s));const n=new AbortController;e.sendMessageController=n,(0,g.e)("Called customSendMessage",s),await a(s,{signal:n.signal},this.serviceManager.instance),await this.processSuccess(e,null)}catch(t){(0,g.b)("An error occurred while sending a message",t);const s=t&&("string"==typeof t?t:JSON.stringify(t))||"There was an unidentified error.";this.processError(e,s,!a)}}async runQueueIfReady(){if(!this.queue.current&&this.queue.waiting.length>0){const{eventBus:e,store:t}=this.serviceManager;this.clearCurrentQueueItem(),this.queue.current=this.queue.waiting.shift();const{current:s}=this.queue,{message:a,source:n}=s,r=t.getState(),{config:i}=t.getState(),{public:o}=i;if(s.timeFirstRequest=Date.now(),a.input.message_type!==C.d.EVENT){if((0,M.C)(r)&&(a.thread_id=M.T),!a.history.is_welcome_request){const e=o.messaging?.messageLoadingIndicatorTimeoutSecs||0===o.messaging?.messageLoadingIndicatorTimeoutSecs?1e3*o.messaging.messageLoadingIndicatorTimeoutSecs:4e3;this.messageLoadingManager.start(()=>{this.serviceManager.store.dispatch(l.a.addIsLoadingCounter(1))},e=>{e&&this.serviceManager.store.dispatch(l.a.addIsLoadingCounter(-1))},()=>{this.cancelMessageRequestByID(a.id,!0)},e,this.timeoutMS)}if(s.isProcessed)return;const i=a.history?.label||a.input.text;if(await e.fire({type:m.B.PRE_SEND,data:a,source:n},this.serviceManager.instance),s.isProcessed)return;const c=(0,y.i)(a,i,s.localMessageID);a.history.silent||(t.dispatch(l.a.updateLocalMessageItem(c)),t.dispatch(l.a.updateMessage(a))),(0,y.d)(a),await e.fire({type:m.B.SEND,data:a,source:n},this.serviceManager.instance)}this.sendToAssistant(s)}}addToMessageQueue(e,t,s,a,n={}){const r={localMessageID:s,message:e,sendMessagePromise:a,requestOptions:n||{},timeFirstRequest:0,timeLastRequest:0,trackData:{numErrors:0,lastRequestTime:0,totalRequestTime:0},tryCount:0,isProcessed:!1,source:t};this.queue.waiting.push(r),this.queue.current&&e.history?.error_state===v.M.RETRYING&&this.setMessageErrorState(r,v.M.WAITING)}clearCurrentQueueItem(){this.queue.current&&(this.queue.current=null)}moveToNextQueueItem(){this.clearCurrentQueueItem(),this.runQueueIfReady()}setMessageErrorState(e,t){const{message:s}=e,{allMessagesByID:a}=this.serviceManager.store.getState(),n=a[s.id];if(n){const a=n.history?.error_state;if(a!==t&&(t!==v.M.NONE||a)){let a;t===v.M.FAILED&&(a="errors_ariaMessageFailed"),a&&this.serviceManager.store.dispatch(l.a.announceMessage({messageID:a})),this.serviceManager.store.dispatch(l.a.setMessageErrorState(s.id,t));const{allMessagesByID:n}=this.serviceManager.store.getState();e.message=n[s.id]}}}send(e,t,s,a){e.history.timestamp=e.history.timestamp||Date.now(),e.input=e.input||{},e.input.message_type=e.input.message_type||C.d.TEXT;const n=(0,y.r)();return this.addToMessageQueue(e,t,s,n,a),this.runQueueIfReady(),n}cancelAllMessageRequests(){for(;this.queue.waiting.length;)this.cancelMessageRequestByID(this.queue.waiting[0].message.id,!1);this.queue.current&&(this.cancelMessageRequestByID(this.queue.current.message.id,!1),this.clearCurrentQueueItem())}async cancelMessageRequestByID(e,t){let s;if(this.queue.current?.message.id===e)s=this.queue.current;else{const t=this.queue.waiting.findIndex(t=>t.message.id===e);-1!==t&&(s=this.queue.waiting[t],this.queue.waiting.splice(t,1))}if(s){const{lastResponse:e,sendMessageController:a}=s;a?.abort("Message was cancelled"),this.rejectFinalErrorOnMessage(s,"Message was cancelled"),t&&this.serviceManager.actions.errorOccurred({errorType:C.O.MESSAGE_COMMUNICATION,message:"Message was cancelled",otherData:await(0,g.k)(e)})}}}class Qe{constructor(e){this.originalName=e,this.attributeSafe=e,this.suffix=function(e){const t=function(e){return e?e.trim():""}(e);return t?.length?`--${e}`:""}(e)}}class Ke{constructor(){this.userDefinedElementRegistry=new Map,this.restartCount=0}async fire(e){return this.eventBus.fire(e,this.instance)}}let Xe={};const Je={getItem(e){return Xe[e]},setItem(e,t){Xe[e]=t},removeItem(e){delete Xe[e]},length:Object.keys(Xe).length,clear(){Xe={}},key(e){return Object.keys(Xe)[e]}},Ze=(0,T.a)()?window.sessionStorage:Je;class et{constructor(e){this.serviceManager=e,this.prefix=`CARBON_CHAT_SESSION${this.serviceManager?.namespace?.suffix||""}`}loadChatSession(){try{const e=Ze.getItem(this.getChatSessionKey()),t=e?JSON.parse(e):null;return t?.version===X?t:(this.clearChatSession(),null)}catch(e){return this.clearChatSession(),null}}loadLauncherSession(){try{const e=Ze.getItem(this.getLauncherSessionKey()),t=e?JSON.parse(e):null;return t?.version===X?(t.wasLoadedFromBrowser=!0,t):(this.clearLauncherSession(),null)}catch(e){return this.clearLauncherSession(),null}}persistChatSession(e){try{Ze.setItem(this.getChatSessionKey(),JSON.stringify(e))}catch(e){(0,g.b)("Error in persistChatSession",e)}}persistLauncherSession(e){try{Ze.setItem(this.getLauncherSessionKey(),JSON.stringify(e))}catch(e){(0,g.b)("Error in persistLauncherSession",e)}}clearChatSession(){try{Ze.removeItem(this.getChatSessionKey())}catch(e){(0,g.b)("Error in clearChatSession",e)}}clearLauncherSession(){try{Ze.removeItem(this.getLauncherSessionKey())}catch(e){(0,g.b)("Error in clearLauncherSession",e)}}getChatSessionKey(){return this.prefix}getLauncherSessionKey(){return this.prefix}}function tt(e,t){if(Array.isArray(t))return t}const st={[y.s]:(e,t)=>{const{isConnecting:s,localMessageID:a}=t;return{...e,humanAgentState:{...e.humanAgentState,isConnecting:s,activeLocalMessageID:a,numUnreadMessages:s?0:e.humanAgentState.numUnreadMessages},persistedToBrowserStorage:{...e.persistedToBrowserStorage,chatState:{...e.persistedToBrowserStorage.chatState,humanAgentState:{...e.persistedToBrowserStorage.chatState.humanAgentState,isSuspended:!!s&&e.persistedToBrowserStorage.chatState.humanAgentState.isSuspended}}}}},[y.q]:(e,t)=>{const{isReconnecting:s}=t;return{...e,humanAgentState:{...e.humanAgentState,isReconnecting:s}}},[y.p]:(e,t)=>e.humanAgentState.isConnecting?{...e,humanAgentState:{...e.humanAgentState,availability:e.humanAgentState.isConnecting?t.availability:null}}:e,[y.n]:(e,{showRequest:t})=>({...e,humanAgentState:{...e.humanAgentState,showScreenShareRequest:t}}),[y.m]:(e,t)=>{const s={...e.persistedToBrowserStorage.chatState.humanAgentState.responseUserProfiles},{responseUserProfile:a}=t;return a&&(s[a.id]=a),{...e,humanAgentState:{...e.humanAgentState,isConnecting:!1,isReconnecting:!1,availability:null},persistedToBrowserStorage:{...e.persistedToBrowserStorage,chatState:{...e.persistedToBrowserStorage.chatState,humanAgentState:{...e.persistedToBrowserStorage.chatState.humanAgentState,isConnected:!0,responseUserProfile:a,responseUserProfiles:s}}}}},[y.l]:(e,t)=>({...e,persistedToBrowserStorage:{...e.persistedToBrowserStorage,chatState:{...e.persistedToBrowserStorage.chatState,humanAgentState:{...e.persistedToBrowserStorage.chatState.humanAgentState,serviceDeskState:t.state}}}}),[y.k]:(e,t)=>e.humanAgentState.isConnecting||e.persistedToBrowserStorage.chatState.humanAgentState.isConnected?{...e,persistedToBrowserStorage:{...e.persistedToBrowserStorage,chatState:{...e.persistedToBrowserStorage.chatState,humanAgentState:{...e.persistedToBrowserStorage.chatState.humanAgentState,isSuspended:t.isSuspended}}}}:e,[y.j]:(e,t)=>({...e,humanAgentState:{...e.humanAgentState,isHumanAgentTyping:t.isTyping}}),[y.h]:e=>({...e,botMessageState:{...e.botMessageState},humanAgentState:{...e.humanAgentState,isHumanAgentTyping:!1},persistedToBrowserStorage:{...e.persistedToBrowserStorage,chatState:{...e.persistedToBrowserStorage.chatState,humanAgentState:{...e.persistedToBrowserStorage.chatState.humanAgentState,responseUserProfile:null}}}}),[y.g]:(e,t)=>{const s={...e.humanAgentState.inputState,...t.capabilities};return s.allowFileUploads||(s.files=[]),{...e,humanAgentState:{...e.humanAgentState,inputState:s}}},[y.f]:(e,{isSharing:t})=>({...e,humanAgentState:{...e.humanAgentState,isScreenSharing:t}}),[y.e]:(e,t)=>({...e,humanAgentState:{...e.humanAgentState,fileUploadInProgress:t.fileUploadInProgress}}),[y.H]:e=>{let t=Ce(e,e.humanAgentState.activeLocalMessageID,"wasHumanAgentChatEnded",!0);return t={...t,humanAgentState:{...t.humanAgentState,isConnecting:!1,isReconnecting:!1,availability:null,activeLocalMessageID:null,isHumanAgentTyping:!1,inputState:{...t.humanAgentState.inputState,isReadonly:!1}},persistedToBrowserStorage:{...e.persistedToBrowserStorage,chatState:{...e.persistedToBrowserStorage.chatState,humanAgentState:{...e.persistedToBrowserStorage.chatState.humanAgentState,isConnected:!1,isSuspended:!1,responseUserProfile:null}}}},t}};function at(e){const{activeTourID:t}=e.persistedToBrowserStorage.chatState.persistedTourState;if(t){const s=e.allMessagesByID[t],a=s?.output?.generic?.find(e=>Boolean(e.user_defined?.steps));if(a)return{...e,tourState:{...e.tourState,activeTourStepItems:a.user_defined?.steps}}}return nt(e)}function nt(e){return{...e,persistedToBrowserStorage:{...e.persistedToBrowserStorage,chatState:{...e.persistedToBrowserStorage.chatState,persistedTourState:{activeTourID:null,activeTourCurrentStepIndex:null}},launcherState:{...e.persistedToBrowserStorage.launcherState,activeTour:!1}},tourState:{...e.tourState,activeTourStepItems:null}}}const rt=new Set([C.H.USER_ENDED_CHAT,C.H.CHAT_WAS_ENDED,C.H.RELOAD_WARNING]),it={[l.ae]:(e,t)=>(0,o.A)({},e,t.partialState),[l.ad]:e=>({...e,isHydrated:!0}),[l.ac]:e=>{let t={...e,botMessageState:{...e.botMessageState,localMessageIDs:[],messageIDs:[],isTypingCounter:0,isScrollAnchored:!1},allMessageItemsByID:{},allMessagesByID:{},iFramePanelState:{...ae},viewSourcePanelState:{...ne},customPanelState:{...se},persistedToBrowserStorage:{...e.persistedToBrowserStorage,chatState:{...e.persistedToBrowserStorage.chatState,homeScreenState:{...e.persistedToBrowserStorage.chatState.homeScreenState,showBackToBot:!1}}},isHydrated:!1,catastrophicErrorType:null};return t=nt(t),t.homeScreenConfig.is_on&&(t=fe(t,!0)),t},[l.ab]:(e,t)=>{let s={...e,...t.messageHistory};return e.persistedToBrowserStorage.chatState.persistedTourState.activeTourID&&(s=at(s)),s},[l.aa]:(e,t)=>{const{messageItem:s,message:a,addMessage:n,addAfterID:r}=t,{id:i}=s.ui_state,o=a.history.silent;let c=e;n&&(c=ye(c,a));const l=c.botMessageState.localMessageIDs.findIndex(e=>e===i),u=[...c.botMessageState.localMessageIDs];let d=l;if(-1!==l?u.splice(l,1):d=u.length,r){const e=u.findIndex(e=>e===r);-1!==e&&(d=e+1)}if(u.splice(d,0,i),!o){c={...c,allMessageItemsByID:{...c.allMessageItemsByID,[i]:s},botMessageState:{...c.botMessageState,localMessageIDs:u}},c.persistedToBrowserStorage.chatState.homeScreenState.isHomeScreenOpen&&(c=fe(c,!1));const t=!s.item.agent_message_type,n=e.persistedToBrowserStorage.launcherState.viewState.mainWindow;t||n&&e.isBrowserPageVisible||!(0,M.a)(a)&&!rt.has(s.item.agent_message_type)&&(c={...c,humanAgentState:{...c.humanAgentState,numUnreadMessages:c.humanAgentState.numUnreadMessages+1}})}return c},[l.a9]:(e,{messageIDs:t})=>{const s=new Set(t),a={...e.allMessagesByID},n={...e.allMessageItemsByID},r=e.botMessageState.messageIDs.filter(e=>!s.has(e)),i=e.botMessageState.localMessageIDs.filter(e=>{const t=n[e],a=s.has(t?.fullMessageID);return a&&delete n[e],!a});return t.forEach(e=>{delete a[e]}),{...e,allMessagesByID:a,allMessageItemsByID:n,botMessageState:{...e.botMessageState,messageIDs:r,localMessageIDs:i}}},[l.a8]:(e,t)=>{const{messageItem:s}=t;return{...e,allMessageItemsByID:{...e.allMessageItemsByID,[s.ui_state.id]:s}}},[l.a7]:(e,t)=>{const{message:s}=t;return{...e,allMessagesByID:{...e.allMessagesByID,[s.id]:s}}},[l.a6]:(e,t)=>{const{message:s}=t,a=s.id;let n=e;if((0,M.b)(s)){const t=[];s.output.generic.forEach(e=>{const s=(0,M.t)(a,e);s&&t.push(s)});const r={...e.allMessageItemsByID},i=[];let o;const c=e.botMessageState.localMessageIDs.filter((s,n)=>{const c=e.allMessageItemsByID[s].fullMessageID===a;return c&&(void 0===o&&(o=n),t.includes(s)?i.push(s):delete r[s]),!c});if(i.length){const e=t.filter(e=>i.includes(e));e.length&&c.splice(o,0,...e)}n={...n,allMessageItemsByID:r,botMessageState:{...n.botMessageState,localMessageIDs:c}}}return ye(n,s)},[l.a5]:(e,t)=>{const s={...e.allMessageItemsByID};return s[t.messageID]={...e.allMessageItemsByID[t.messageID],ui_state:{...e.allMessageItemsByID[t.messageID].ui_state,optionSelected:t.sentMessage}},{...e,allMessageItemsByID:s}},[l.a4]:(e,t)=>({...e,botMessageState:{...e.botMessageState,isTypingCounter:Math.max(e.botMessageState.isTypingCounter+t.addToIsTyping,0)}}),[l.a3]:(e,t)=>({...e,botMessageState:{...e.botMessageState,isLoadingCounter:Math.max(e.botMessageState.isLoadingCounter+t.addToIsLoading,0)}}),[l.a2]:(e,t)=>({...e,botMessageState:{...e.botMessageState,isHydratingCounter:Math.max(e.botMessageState.isHydratingCounter+t.addToIsHydrating,0)}}),[l.a1]:(e,t)=>({...e,[t.key]:t.value}),[l.a0]:(e,t)=>({...e,persistedToBrowserStorage:{...e.persistedToBrowserStorage,chatState:{...e.persistedToBrowserStorage.chatState,...t.chatState}}}),[l.$]:(e,t)=>e.persistedToBrowserStorage.chatState.hasSentNonWelcomeMessage===t.hasSentNonWelcomeMessage?e:{...e,persistedToBrowserStorage:{...e.persistedToBrowserStorage,chatState:{...e.persistedToBrowserStorage.chatState,hasSentNonWelcomeMessage:t.hasSentNonWelcomeMessage},launcherState:{...e.persistedToBrowserStorage.launcherState,hasSentNonWelcomeMessage:t.hasSentNonWelcomeMessage}}},[l._]:(e,t)=>function(e,t){let{humanAgentState:s}=e,{showUnreadIndicator:n}=e.persistedToBrowserStorage.launcherState;return t.mainWindow&&e.isBrowserPageVisible&&(0!==s.numUnreadMessages&&(s={...s,numUnreadMessages:0}),n=!1),{...e,announceMessage:(r=e,i=t,(0,a.A)(r.persistedToBrowserStorage.launcherState.viewState,i)?r.announceMessage:{messageID:i.mainWindow?"window_ariaWindowOpened":"window_ariaWindowClosed"}),humanAgentState:s,persistedToBrowserStorage:{...e.persistedToBrowserStorage,launcherState:{...e.persistedToBrowserStorage.launcherState,viewState:t,showUnreadIndicator:n}}};var r,i}(e,t.viewState),[l.Z]:(e,t)=>({...e,viewChanging:t.viewChanging}),[l.Y]:(e,t)=>({...e,initialViewChangeComplete:t.changeComplete}),[l.X]:(e,t)=>({...e,botName:t.name,headerDisplayName:e.theme.useAITheme?e.headerDisplayName:t.name}),[l.W]:(e,t)=>({...e,botAvatarURL:t.url}),[l.V]:(e,t)=>({...e,launcher:{...e.launcher,config:{...e.launcher.config,mobile:{...e.launcher.config.mobile,avatar_url_override:t.source},desktop:{...e.launcher.config.desktop,avatar_url_override:t.source}}}}),[l.Q]:(e,t)=>({...e,headerDisplayName:t.title}),[l.P]:(e,t)=>{const{config:s}=e,{variables:a}=t,n={public:{...s.public}};return{...e,config:n,cssVariableOverrides:a}},[l.N]:(e,t)=>{const s=t.homeScreenConfig;return{...e,homeScreenConfig:(0,_.A)({},e.homeScreenConfig,s,tt)}},[l.L]:(e,t)=>Ce(e,t.localMessageID,t.propertyName,t.propertyValue),[l.K]:(e,t)=>{const{messageID:s,propertyName:a,propertyValue:n}=t,r=e.allMessagesByID[s];return r?{...e,allMessagesByID:{...e.allMessagesByID,[s]:{...r,history:{...r.history,[a]:n}}}}:e},[l.J]:(e,t)=>{const{messageID:s,propertyName:a,propertyValue:n}=t,r=e.allMessagesByID[s];return r?{...e,allMessagesByID:{...e.allMessagesByID,[s]:{...r,ui_state_internal:{...r.ui_state_internal,[a]:n}}}}:e},[l.M]:(e,t)=>{const s=e.allMessagesByID[t.messageID];return s?{...e,allMessagesByID:{...e.allMessagesByID,[t.messageID]:{...s,history:(0,o.A)({},s.history,t.history)}}}:e},[l.I]:(e,t)=>({...e,announceMessage:t.message}),[l.H]:e=>({...e,persistedToBrowserStorage:{...e.persistedToBrowserStorage,chatState:{...e.persistedToBrowserStorage.chatState,disclaimersAccepted:{...e.persistedToBrowserStorage.chatState.disclaimersAccepted,[window.location.hostname]:!0}}}}),[l.G]:(e,{isOpen:t})=>fe(e,t),[l.T]:e=>fe(e,!e.persistedToBrowserStorage.chatState.homeScreenState.isHomeScreenOpen,!0),[l.E]:(e,t)=>{const s=(0,o.A)({},e.launcher.config,t.launcherConfig);return{...e,launcher:{...e.launcher,config:s},persistedToBrowserStorage:{...e.persistedToBrowserStorage,launcherState:{...e.persistedToBrowserStorage.launcherState,desktopLauncherIsExpanded:!(!s.is_on||!s.desktop.is_on)&&e.persistedToBrowserStorage.launcherState.desktopLauncherIsExpanded,mobileLauncherIsExtended:!(!s.is_on||!s.mobile.is_on)&&e.persistedToBrowserStorage.launcherState.mobileLauncherIsExtended}}}},[l.D]:(e,t)=>({...e,persistedToBrowserStorage:{...e.persistedToBrowserStorage,launcherState:{...e.persistedToBrowserStorage.launcherState,[t.propertyName]:t.propertyValue}}}),[l.B]:(e,t)=>{const s={...e,launcher:{...e.launcher,config:{...e.launcher.config}}};return t.launcherType&&t.launcherType!==C.L.DESKTOP||(s.launcher.config.desktop={...e.launcher.config.desktop,[t.propertyName]:t.propertyValue}),t.launcherType&&t.launcherType!==C.L.MOBILE||(s.launcher.config.mobile={...e.launcher.config.mobile,[t.propertyName]:t.propertyValue}),s},[l.z]:(e,t)=>Se(e,{[t.propertyName]:t.propertyValue}),[l.y]:e=>({...e,persistedToBrowserStorage:{...e.persistedToBrowserStorage,launcherState:{...e.persistedToBrowserStorage.launcherState,desktopLauncherIsExpanded:!1,desktopLauncherWasMinimized:!0}}}),[l.O]:(e,{messageItem:t})=>({...e,iFramePanelState:{...e.iFramePanelState,messageItem:t,isOpen:!0},announceMessage:{messageID:"iframe_ariaOpenedPanel"}}),[l.x]:e=>({...e,iFramePanelState:{...e.iFramePanelState,isOpen:!1},announceMessage:{messageID:"iframe_ariaClosedPanel"}}),[l.w]:(e,t)=>({...e,viewSourcePanelState:{...e.viewSourcePanelState,citationItem:t.citationItem,relatedSearchResult:t.relatedSearchResult,isOpen:t.isOpen}}),[l.v]:(e,t)=>({...e,customPanelState:{...e.customPanelState,isOpen:t.isOpen}}),[l.u]:(e,t)=>({...e,customPanelState:{...e.customPanelState,options:t.options}}),[l.t]:(e,t)=>at({...e,persistedToBrowserStorage:{...e.persistedToBrowserStorage,chatState:{...e.persistedToBrowserStorage.chatState,persistedTourState:{activeTourID:t.newActiveTourMessageID,activeTourCurrentStepIndex:0}},launcherState:{...e.persistedToBrowserStorage.launcherState,activeTour:!0}}}),[l.s]:e=>nt(e),[l.r]:(e,t)=>({...e,persistedToBrowserStorage:{...e.persistedToBrowserStorage,chatState:{...e.persistedToBrowserStorage.chatState,persistedTourState:{...e.persistedToBrowserStorage.chatState.persistedTourState,activeTourCurrentStepIndex:Math.max(Math.min(t.newStepNumber,e.tourState.activeTourStepItems.length-1),0)}}}}),[l.q]:(e,t)=>ot(e,{...ct(e,t.isInputToHumanAgent),...t.newState},t.isInputToHumanAgent),[l.p]:(e,t)=>{let s;return s=e.persistedToBrowserStorage.launcherState.viewState.mainWindow&&t.isVisible?0:e.humanAgentState.numUnreadMessages,{...e,isBrowserPageVisible:t.isVisible,humanAgentState:{...e.humanAgentState,numUnreadMessages:s}}},[l.o]:(e,{file:t,isInputToHumanAgent:s})=>{const a=ct(e,s);return ot(e,{...a,files:[...a.files,t]},s)},[l.n]:(e,{fileID:t,isInputToHumanAgent:s})=>{const a=ct(e,s),n=[...a.files],r=n.findIndex(e=>e.id===t);return-1!==r&&n.splice(r,1),ot(e,{...a,files:n},s)},[l.m]:(e,{localMessageItemID:t})=>{const s=e.botMessageState.localMessageIDs.filter(e=>e!==t),a={...e.allMessageItemsByID};return a[t]&&delete a[t],{...e,allMessageItemsByID:a,botMessageState:{...e.botMessageState,localMessageIDs:s}}},[l.l]:(e,{notification:t,notificationID:s})=>({...e,notifications:e.notifications.concat({id:s,notification:t})}),[l.k]:(e,{groupID:t,notificationID:s})=>({...e,notifications:e.notifications.filter(e=>s?e.id!==s:e.notification.groupID!==t)}),[l.R]:e=>({...e,notifications:[]}),[l.C]:(e,{isInputToHumanAgent:t})=>ot(e,{...ct(e,t),files:[]},t),[l.F]:(e,{fileID:t,errorMessage:s,isInputToHumanAgent:a})=>{const n=ct(e,a),r=[...n.files],i=r.findIndex(e=>e.id===t);return-1!==i&&(r[i]={...r[i],isError:!0,errorMessage:s,status:C.F.COMPLETE}),ot(e,{...n,files:r},a)},[l.A]:(e,{localMessageItems:t})=>{const s={...e.allMessageItemsByID};return t.forEach(e=>{s[e.ui_state.id]=e}),{...e,allMessageItemsByID:s}},[l.j]:(e,{isOpen:t})=>({...e,responsePanelState:{...e.responsePanelState,isOpen:t}}),[l.i]:(e,{localMessageItem:t,isMessageForInput:s})=>({...e,responsePanelState:{...e.responsePanelState,localMessageItem:t,isMessageForInput:s}}),[l.h]:(e,{messageID:t})=>ye(e,{id:t,output:{generic:[]},history:{timestamp:Date.now()}}),[l.g]:(e,{messageID:t,history:s})=>{const a=e.allMessagesByID[t],n=(0,o.A)({},a,{history:s});return a?{...e,allMessagesByID:{...e.allMessagesByID,[t]:n}}:e},[l.f]:(e,{chunkItem:t,fullMessageID:s,isCompleteItem:a,disableFadeAnimation:n})=>{const r=e.allMessagesByID[s],i=(0,M.t)(s,t),o=e.allMessageItemsByID[i];let c,{localMessageIDs:l}=e.botMessageState;if(o)if(a){const e={...o.item,...t};c={...o,item:e,ui_state:{...o.ui_state,isIntermediateStreaming:!1,streamingState:{chunks:[],isDone:!0}}}}else{const e=[...o?.ui_state.streamingState?.chunks||[],t];c={...o,ui_state:{...o?.ui_state,streamingState:{...o?.ui_state.streamingState,chunks:e}}}}else if(c=(0,y.o)(t,r,!1),c.ui_state.needsAnnouncement=!1,c.ui_state.disableFadeAnimation=n,c.ui_state.isIntermediateStreaming=!0,c.ui_state.streamingState=a?{chunks:[],isDone:!0}:{chunks:[t],isDone:!1},l=[...l,i],!c.item.response_type)throw new Error(`New chunk item does not have a response_type: ${JSON.stringify(t)}`);return{...e,allMessageItemsByID:{...e.allMessageItemsByID,[i]:c},botMessageState:{...e.botMessageState,localMessageIDs:l}}},[l.e]:(e,{chatHeaderConfig:t})=>({...e,chatHeaderState:{...e.chatHeaderState,config:{...e.chatHeaderState.config,...t}}}),[l.d]:(e,{maxTotal:t})=>({...e,chatHeaderState:{...e.chatHeaderState,maxVisibleHeaderObjects:t}}),[l.c]:(e,{isVisible:t})=>({...e,botInputState:{...e.botInputState,stopStreamingButtonState:{...e.botInputState.stopStreamingButtonState,isVisible:t}}}),[l.b]:(e,{isDisabled:t})=>({...e,botInputState:{...e.botInputState,stopStreamingButtonState:{...e.botInputState.stopStreamingButtonState,isDisabled:t}}}),[l.S]:(e,{currentStreamID:t})=>({...e,botInputState:{...e.botInputState,stopStreamingButtonState:{...e.botInputState.stopStreamingButtonState,currentStreamID:t}}}),[l.U]:(e,{config:t})=>({...e,headerAvatarConfig:t})};function ot(e,t,s){return s?{...e,humanAgentState:{...e.humanAgentState,inputState:t}}:{...e,botInputState:t}}function ct(e,t){return t?e.humanAgentState.inputState:e.botInputState}function lt(e){return!1===ut(e).showFrame||T.b||e.public.themeConfig?.corners===C.a.SQUARE?C.a.SQUARE:me.corners}function ut(e){return e.public.themeConfig?.useAITheme?{showFrame:e.public.layout?.showFrame??!0,hasContentMaxWidth:e.public.layout?.hasContentMaxWidth??!0}:(0,o.A)({},pe,e.public.layout)}function dt(e,t){return t&&it[t.type]?it[t.type](e,t):e}Object.assign(it,st);const ht={openChatByDefault:!1,showLauncher:!0,shouldTakeFocusIfOpensAutomatically:!0,serviceDesk:{},messaging:{},themeConfig:{useAITheme:!0}};r.extend(i);let gt=class{constructor(e,t,s){e?.debug&&(0,g.d)("Constructed chat widget",e);const a=(0,o.A)({},ht,e);this.additionalChatParameters=s||{},this.appConfig={public:a},this.customHostElement=t}async start(){try{return(await this.startInternal()).instance}catch(e){return(0,g.b)("There was an error starting your chat",e),null}}async startInternal(){const e=(0,M.w)(this.appConfig);this.serviceManager=await async function(e,t){const s=e.public,a=new Ke;return a.additionalChatParameters=t,a.namespace=new Qe(s.namespace),a.userSessionStorageService=new et(a),a.actions=new xe(a),a.eventBus=new Ue,a.store=function(e,t){let s;s=void 0!==e.public.themeConfig?.useAITheme?e.public.themeConfig?.useAITheme:me.useAITheme;const a={carbonTheme:e.public.themeConfig?.carbonTheme||me.carbonTheme,useAITheme:s,corners:lt(e)},n=(0,g.l)(a.useAITheme,e),r={...he,notifications:[],botInputState:{fieldVisible:!0,isReadonly:!1,files:[],allowFileUploads:!1,allowMultipleFileUploads:!1,allowedFileUploadTypes:null,stopStreamingButtonState:{currentStreamID:null,isVisible:!1,isDisabled:!1},isReadonly:e.public.isReadonly,fieldVisible:!e.public.isReadonly},humanAgentState:{...ge},botName:n,headerDisplayName:null,botAvatarURL:e.public.botAvatarURL||null,headerAvatarConfig:null,chatWidthBreakpoint:null,chatWidth:null,chatHeight:null,cssVariableOverrides:Oe({},{},a.carbonTheme,a.useAITheme),isHydrated:!1,languagePack:h.e,locale:"en",config:e,originalConfig:e,suspendScrollDetection:!1,homeScreenConfig:z({}),persistedToBrowserStorage:{...ue,chatState:{...ue.chatState,homeScreenState:{...ue.chatState.homeScreenState}}},launcher:(0,o.A)({},ee,{config:(0,o.A)({},{},{mobile:{}},{is_on:e.public.showLauncher})}),iFramePanelState:ae,viewSourcePanelState:ne,isDestroyed:!1,customPanelState:se,viewChanging:!1,initialViewChangeComplete:!1,targetViewState:e.public.openChatByDefault?le:ce,responsePanelState:ie,customMenuOptions:null,tourState:re,isBrowserPageVisible:!0,showNonHeaderBackgroundCover:!1,theme:a,layout:ut(e),chatHeaderState:{config:null,maxVisibleHeaderObjects:0}},i=t.userSessionStorageService?.loadLauncherSession();i&&(r.targetViewState=i.viewState,i.viewState=oe,r.persistedToBrowserStorage.launcherState=i);const c=e.public.debug?window.__REDUX_DEVTOOLS_EXTENSION__&&window.__REDUX_DEVTOOLS_EXTENSION__({name:"CarbonAIChat",instanceId:`Chat${t.namespace.suffix}`}):void 0;return(0,b.y$)(dt,r,c)}(e,a),a.historyService=new qe(a),a.messageService=new ze(a,s),a.store.subscribe(function(e){let t=e.store.getState().persistedToBrowserStorage;return()=>{const{persistedToBrowserStorage:s}=e.store.getState();t!==s&&(t=s,e.userSessionStorageService.persistChatSession(s.chatState),e.userSessionStorageService.persistLauncherSession(s.launcherState))}}(a)),s.disableWindowTitleChanges||a.store.subscribe(function(e){const{store:t}=e;let s,a,n=t.getState();return()=>{const e=t.getState(),{humanAgentState:r}=t.getState(),{numUnreadMessages:i}=r;i!==n.humanAgentState.numUnreadMessages&&(i?(clearTimeout(a),s||(s=window.document.title),window.document.title=e.languagePack.agent_newMessage,a=setTimeout(()=>{window.document.title=`(${i}) ${s}`},1e4)):(clearTimeout(a),s&&(window.document.title=s,s=null))),n=e}}(a)),a.customPanelManager=function(e){const t={[E.D]:$e(e)};return Object.freeze({getPanel(){return t[E.D]}})}(a),Q(a,a.store.getState().locale,a.store.getState().languagePack),a.writeableElements={[C.W.AI_TOOLTIP_AFTER_DESCRIPTION_ELEMENT]:document.createElement("div"),[C.W.WELCOME_NODE_BEFORE_ELEMENT]:document.createElement("div"),[C.W.HEADER_BOTTOM_ELEMENT]:document.createElement("div"),[C.W.BEFORE_INPUT_ELEMENT]:document.createElement("div"),[C.W.HOME_SCREEN_HEADER_BOTTOM_ELEMENT]:document.createElement("div"),[C.W.HOME_SCREEN_AFTER_STARTERS_ELEMENT]:document.createElement("div"),[C.W.HOME_SCREEN_BEFORE_INPUT_ELEMENT]:document.createElement("div"),[C.W.CUSTOM_PANEL_ELEMENT]:document.createElement("div")},s.debug&&(0,g.m)(!0),s.debugStackTraces&&(0,g.n)(!0),a}(this.appConfig,this.additionalChatParameters);const[t,s,n,i]=await Promise.all([(0,h.b)(this.serviceManager.store.getState().languagePack),(0,h.l)(this.serviceManager.store.getState().locale),Promise.resolve(this.additionalChatParameters.render),e?(0,C.l)():Promise.resolve(null)]);this.serviceManager.customHostElement=this.customHostElement,i&&(this.serviceManager.humanAgentService=i(this.serviceManager)),Q(this.serviceManager,s.name,t),r.locale(s);const d=async()=>{await n({serviceManager:this.serviceManager});const e=this.serviceManager.store.getState(),{wasLoadedFromBrowser:t}=e.persistedToBrowserStorage.launcherState,{targetViewState:s}=e,{openChatByDefault:r}=e.config.public;if(s.mainWindow){let e=m.b.SESSION_HISTORY;r&&!t&&(e=m.b.OPEN_BY_DEFAULT),await this.serviceManager.actions.changeView(s,{mainWindowOpenReason:e})}else{const e=m.V.WEB_CHAT_LOADED,t=s.tour,n=(0,a.A)(s,oe);await this.serviceManager.actions.changeView(s,{viewChangeReason:e},t,n)}return this.serviceManager.store.dispatch(l.a.setInitialViewChangeComplete(!0)),this.serviceManager.instance};return this.serviceManager.instance=function({serviceManager:e,callRender:t}){let s=!1,a={render:()=>s?((0,g.b)("The render function has already been called!"),Promise.resolve(a)):(s=!0,t()),on:t=>(e.eventBus.on(t),a),off:t=>(e.eventBus.off(t),a),once:t=>(e.eventBus.once(t),a),updateLanguagePack:t=>((0,g.e)("Called instance.updateLanguagePack",t),e.actions.updateLanguagePack(t)),updateLocale:t=>{(0,g.e)("Called instance.updateLocale",t);const s=(0,h.l)(t),a=(0,h.b)(e.store.getState().languagePack);return Promise.all([s,a]).then(([t,s])=>{r.locale(t),Q(e,t.name,s),e.messageService.pendingLocale=!0,e.messageService.localeIsExplicit=!0})},updateCSSVariables:(t,s)=>((0,g.e)("Called instance.updateCSSVariables",t),e.actions.updateCSSVariables(t,s)),send:async(t,s)=>{if((0,g.e)("Called instance.send",t,s),(0,u.a)(e.store.getState()).isReadonly)throw new Error("You are unable to send messages in read only mode.");return e.actions.send(t,m.M.INSTANCE_SEND,s)},doAutoScroll:(t={})=>{(0,g.e)("Called instance.doAutoScroll",t),e.mainWindow?.doAutoScroll?.(t)},destroy:()=>{(0,g.e)("Called instance.destroy"),e.store.dispatch(l.a.setAppStateValue("isDestroyed",!0)),e.container?.remove(),a=void 0},updateAssistantInputFieldVisibility:t=>{(0,g.e)("Called instance.updateAssistantInputFieldVisibility",t),e.store.dispatch(l.a.updateInputState({fieldVisible:t},!1))},updateInputIsDisabled:t=>{(0,g.e)("Called instance.updateInputIsDisabled",t),e.store.dispatch(l.a.updateInputState({isReadonly:t},!1))},updateBotUnreadIndicatorVisibility:t=>{(0,g.e)("Called instance.updateBotUnreadIndicatorVisibility",t),e.store.dispatch(l.a.setLauncherProperty("showUnreadIndicator",t))},changeView:async t=>{(0,g.e)("Called instance.changeView",t);let a=!1;s||((0,g.b)('You tried to call "changeView" without ever having called the "render" method. There is no view to change!'),a=!0);const n=Object.values(C.V);"string"==typeof t?n.includes(t)||((0,g.b)(`You tried to change the view but the view you specified is not a valid view name. Please use the valid view names; ${n.join(", ")}.`),a=!0):"object"==typeof t?Object.keys(t).forEach(e=>{n.includes(e)||((0,g.b)(`You tried to change the state of multiple views by providing an object, however you included the key "${e}" within the object which is not a valid view name. Please use the valid view names; ${n.join(", ")}.`),a=!0)}):((0,g.b)('You tried to change the view but the view you provided was not a string or an object. You can either change to one of the supported views by providing a string, ex. "launcher", "mainWindow", or "tour". Or you can change the state of multiple views by providing an object, ex. { "launcher": true, "mainWindow": false, "tour": true }. Please use one of these supported options.'),a=!0),a||await e.actions.changeView(t,{viewChangeReason:m.V.CALLED_CHANGE_VIEW})},notifications:{addNotification:t=>{(0,g.e)("Called instance.addNotification",t),e.actions.addNotification(t)},removeNotifications:t=>{(0,g.e)("Called instance.removeNotifications",t),e.actions.removeNotification(t)},removeAllNotifications:()=>{(0,g.e)("Called instance.removeAllNotifications"),e.actions.removeAllNotifications()}},updateMainHeaderTitle:t=>{(0,g.e)("Called instance.updateMainHeaderTitle",t),t||(t=null),e.actions.updateMainHeaderTitle(t)},updateHomeScreenConfig:t=>{(0,g.e)("Called instance.updateHomeScreenConfig",t);const s=(0,c.A)(t);e.store.getState().theme.useAITheme&&t?.background&&((0,g.c)("The home screen background can not be changed when the AI theme is enabled."),delete s.background),e.actions.updateHomeScreenConfig(z(s))},getState:()=>e.actions.getPublicWebChatState(),writeableElements:K(e),scrollToMessage:(t,s)=>{(0,g.e)("Called instance.scrollToMessage",t,s),e.mainWindow?.doScrollToMessage(t,s)},updateLauncherConfig:t=>e.actions.updateLauncherConfig(t),customPanels:e.customPanelManager,updateCustomMenuOptions:t=>{(0,g.e)("Called instance.updateCustomMenuOptions",t),e.store.dispatch(l.a.setAppStateValue("customMenuOptions",t))},restartConversation:async()=>((0,g.e)("Called instance.restartConversation"),e.actions.restartConversation()),agentEndConversation:()=>((0,g.e)("Called instance.agentEndConversation"),(0,g.c)("The instance.agentEndConversation method is deprecated. Use instance.serviceDesk.endConversation instead."),e.actions.agentEndConversation(!1)),updateIsTypingCounter(t){(0,g.e)("Called instance.updateIsTypingCounter",t);const{store:s}=e;if("increase"===t)s.dispatch(l.a.addIsTypingCounter(1));else if("decrease"===t){if(s.getState().botMessageState.isTypingCounter<=0)return void(0,g.b)("You cannot decrease the typing counter when it is already <= 0");s.dispatch(l.a.addIsTypingCounter(-1))}else(0,g.b)(`[updateIsTypingCounter] Invalid direction: ${t}. Valid values are "increase" and "decrease".`)},updateIsLoadingCounter(t){(0,g.e)("Called instance.updateIsLoadingCounter",t);const{store:s}=e;if("increase"===t)s.dispatch(l.a.addIsLoadingCounter(1));else if("decrease"===t){if(s.getState().botMessageState.isLoadingCounter<=0)return void(0,g.b)("You cannot decrease the loading counter when it is already <= 0");s.dispatch(l.a.addIsLoadingCounter(-1))}else(0,g.b)(`[updateIsLoadingCounter] Invalid direction: ${t}. Valid values are "increase" and "decrease".`)},updateIsChatLoadingCounter(t){(0,g.e)("Called instance.updateIsChatLoadingCounter",t);const{store:s}=e;if("increase"===t)s.dispatch(l.a.addIsHydratingCounter(1));else if("decrease"===t){if(s.getState().botMessageState.isHydratingCounter<=0)return void(0,g.b)("You cannot decrease the hydrating counter when it is already <= 0");s.dispatch(l.a.addIsHydratingCounter(-1))}else(0,g.b)(`[updateIsChatLoadingCounter] Invalid direction: ${t}. Valid values are "increase" and "decrease".`)},updateHeaderConfig:t=>{const s=(0,c.A)(t);e.store.dispatch(l.a.updateChatHeaderConfig(s))},updateMainHeaderAvatar:t=>{e.store.dispatch(l.a.updateMainHeaderAvatar(t))},updateBotName:t=>e.actions.updateBotName(t),updateBotAvatarURL:t=>e.actions.updateBotAvatarURL(t),elements:{getMainWindow:function(){return{addClassName:t=>e.mainWindow?.addClassName(t),removeClassName:t=>e.mainWindow?.removeClassName(t)}},getMessageInput:function(){return{getHTMLElement:()=>e.mainWindow?.getMessageInput()?.getHTMLElement(),setValue:t=>e.mainWindow?.getMessageInput()?.setValue(t),setEnableEnterKey:t=>e.mainWindow?.getMessageInput()?.setEnableEnterKey(t),addChangeListener:t=>e.mainWindow?.getMessageInput()?.addChangeListener(t),removeChangeListener:t=>e.mainWindow?.getMessageInput()?.removeChangeListener(t)}},getHomeScreenInput:function(){return{getHTMLElement:()=>e.mainWindow?.getHomeScreenInput()?.getHTMLElement(),setValue:t=>e.mainWindow?.getHomeScreenInput()?.setValue(t),setEnableEnterKey:t=>e.mainWindow?.getHomeScreenInput()?.setEnableEnterKey(t),addChangeListener:t=>e.mainWindow?.getHomeScreenInput()?.addChangeListener(t),removeChangeListener:t=>e.mainWindow?.getHomeScreenInput()?.removeChangeListener(t)}}},tours:{startTour:async t=>{(0,g.e)("Called instance.tours.startTour",t),await e.actions.send(t,m.M.START_TOUR_METHOD,{skipTourCard:!0})},endTour:async()=>{(0,g.e)("Called instance.tours.endTour"),e.actions.endTour({viewChangeReason:m.V.CALLED_END_TOUR})},goToNextStep:async()=>{(0,g.e)("Called instance.tours.goToNextStep"),e.actions.changeStepInTour({nextStep:!0})},goToStep:async t=>{(0,g.e)("Called instance.tours.goToStep",t),e.actions.goToSpecificTourStep(t)}},messaging:{addMessage:(t,s={})=>((0,g.e)("Called instance.messaging.addMessage",t,s),e.messageService.messageLoadingManager.end(),e.actions.receive(t,s?.isLatestWelcomeNode??!1,null,{disableFadeAnimation:s?.disableFadeAnimation})),addMessageChunk:async(t,s={})=>{(0,g.e)("Called instance.messaging.addMessageChunk",t,s),e.messageService.messageLoadingManager.end(),await e.actions.receiveChunk(t,null,s)},removeMessages:async t=>((0,g.e)("Called instance.messaging.removeMessages",t),e.actions.removeMessages(t)),clearConversation:()=>((0,g.e)("Called instance.messaging.clearConversation"),e.actions.restartConversation({skipHydration:!0,endHumanAgentConversation:!1,fireEvents:!1})),insertHistory:t=>((0,g.e)("Called instance.messaging.insertHistory",t),e.actions.insertHistory(t))},requestFocus:()=>{(0,g.e)("Called instance.requestFocus"),e.appWindow?.requestFocus()},serviceDesk:{endConversation:()=>((0,g.e)("Called instance.serviceDesk.endConversation"),e.actions.agentEndConversation(!1)),updateIsSuspended:async t=>((0,g.e)("Called instance.serviceDesk.updateIsSuspended",t),e.actions.agentUpdateIsSuspended(t))}};return e.store.getState().config.public.debug&&(0,g.d)("[ChatInstanceImpl] Created chat instance",a),a}({serviceManager:this.serviceManager,callRender:()=>{const e=d();return this.serviceManager.renderPromise=e,e}}),{instance:this.serviceManager.instance,serviceManager:this.serviceManager}}};function mt(e){const t=(0,f.A)(),{store:s}=(0,D.u)(),a=(0,n.useRef)(),r=(0,n.useCallback)(e=>{a.current?a.current.announceValue(e):setTimeout(()=>a.current.announceValue(e))},[]),i=(0,n.useRef)();return(0,n.useEffect)(()=>s.subscribe(()=>{const e=s.getState().announceMessage;e!==i.current&&(r(e),i.current=e)}),[s,r]),n.createElement(D.A.Provider,{value:r},e.children,n.createElement(P.a,{intl:t,ref:a}))}function pt(e,t,s){return s?t?e.launcher_isTourOpen:e.launcher_isTourClosed:t?e.launcher_isOpen:e.launcher_isClosed}function St(e,t){const{onToggleOpen:s,languagePack:a,unreadHumanAgentCount:r,intl:i,showUnreadIndicator:o,className:c,tabIndex:l,launcherHidden:u,activeTour:d}=e,h=(0,B.d4)(e=>e.theme.useAITheme?void 0:e.launcher.config.desktop.avatar_url_override),g=(0,B.d4)(e=>e.theme.useAITheme),m=n.createRef();(0,n.useImperativeHandle)(t,()=>({requestFocus:()=>{(0,D.d)(m)}}));let p=pt(a,u,d);0!==r&&(p+=`. ${i.formatMessage({id:"icon_ariaUnreadMessages"},{count:r})}`);let S=g?n.createElement(O.A,{size:24,className:"WACLauncher_svg"}):n.createElement(H.A,{size:24,className:"WACLauncher__svg"});return h&&(S=n.createElement("img",{className:"WACLauncher__Avatar",src:h,alt:"","aria-hidden":!0})),n.createElement("div",{className:R("WACLauncher__ButtonContainer","WACLauncher__ButtonContainer--round",c,{"WACLauncher__ButtonContainer--hidden":u})},n.createElement(W.$nd,{"aria-label":p,className:R("WACLauncher__Button",{WACLauncher__TourButton:d}),"data-testid":k.P.LAUNCHER,kind:w.a.PRIMARY,type:"button",onClick:s,ref:m,tabIndex:l},d?n.createElement(L.A,{size:24,className:"WACLauncher__svg"}):S,(0!==r||o)&&n.createElement("div",{className:"WAC__countIndicator"},0!==r?r:"")))}const ft=(0,n.forwardRef)(St);function Ct(e){const{languagePack:t,intl:s,launcherConfig:a,launcherComplexRef:r,launcherRef:i,onOpen:o,onMinimize:c,unreadHumanAgentCount:l,showUnreadIndicator:u,desktopLauncherIsExpanded:d,launcherHidden:h,activeTour:g,className:m}=e,{launcher_desktopGreeting:p,launcher_closeButton:S,launcher_ariaIsExpanded:f}=t;return n.createElement("div",{className:R("WACLauncher__ButtonContainer","WACLauncherComplex__Container",m,{"WACLauncher__ButtonContainer--hidden":h}),ref:r},n.createElement("button",{className:"WACLauncherComplex__ContentButton",type:"button",onClick:o,disabled:!d},n.createElement("div",{className:R("WACWidget__textEllipsis",{WACLauncherComplex__Text:!h})},a.desktop.title?a.desktop.title:p)),n.createElement(ft,{languagePack:t,intl:s,ref:i,onToggleOpen:o,className:"WACLauncherComplex__SmallLauncherContainer",unreadHumanAgentCount:l,showUnreadIndicator:u,launcherHidden:h,activeTour:g}),n.createElement(W.vwO,{className:"WACLauncher__CloseButton","aria-label":f,onClick:c,disabled:!d},n.createElement("div",{className:"WACLauncher__CloseButtonInnerWrapper"},n.createElement(x.A,{className:"WACLauncher__CloseButtonIcon"}),S)))}const yt=e=>{const{launcherRef:t,onDoToggle:s,requestFocus:a,launcherHidden:r,activeTour:i}=e,o=(0,D.u)(),c=(0,d.u)(),u=(0,f.A)(),h=(0,B.d4)(e=>e.persistedToBrowserStorage.launcherState),{desktopLauncherWasMinimized:g,desktopLauncherIsExpanded:m,bounceTurn:p,showUnreadIndicator:S,viewState:y}=h,v=(0,B.d4)(e=>e.launcher).config,{time_to_expand:E,new_expand_time:w}=v.desktop,M=v.desktop.is_on,I=(0,B.d4)(e=>e.humanAgentState.numUnreadMessages),[A,T]=(0,n.useState)(""),[b,_]=(0,n.useState)(""),R=(0,n.useRef)(),P=(0,n.useRef)();P.current=r;const O=(0,n.useRef)(!1),L=(0,n.useRef)();L.current=p;const H=(0,n.useRef)(),W=(0,n.useRef)(),k=(0,n.useRef)(),x=(0,n.useRef)(),V=(0,n.useRef)(),U=(0,n.useRef)(),F=(0,n.useCallback)(()=>{const e=`${R.current?.offsetHeight}px`;R.current?.style?.setProperty&&R.current.style.setProperty("--cds-chat-LAUNCHER-desktop-expanded-height",e)},[]),$=(0,n.useCallback)(()=>{P.current||(o.store.dispatch(l.a.setLauncherProperty("desktopLauncherIsExpanded",!0)),F(),_("WACLauncherComplex__Container--introAnimation"))},[F,o.store]),q=(0,n.useCallback)(()=>{H.current=setTimeout(()=>{$()},E)},[E,$]),G=(0,n.useCallback)(()=>{clearTimeout(H.current),clearTimeout(W.current)},[]),j=(0,n.useCallback)(()=>{P.current||T("WACLauncher__ButtonContainer--bounceAnimation")},[]),Y=(0,n.useCallback)(()=>{P.current||(T("WACLauncher__ButtonContainer--noAnimation"),L.current++,o.store.dispatch(l.a.setLauncherProperty("bounceTurn",L.current)))},[o.store]),z=(0,n.useCallback)(()=>{1===L.current?(k.current=setTimeout(()=>{j()},Z[0]),x.current=setTimeout(()=>{Y()},Z[0]+500),V.current=setTimeout(()=>{j()},Z[0]+Z[1]),U.current=setTimeout(()=>{Y()},Z[0]+Z[1]+500)):2===L.current&&(V.current=setTimeout(()=>{j()},Z[1]),U.current=setTimeout(()=>{Y()},Z[1]+500))},[Y,j]),Q=(0,n.useCallback)(()=>{clearTimeout(k.current),clearTimeout(x.current),clearTimeout(V.current),clearTimeout(U.current)},[]),K=(0,n.useCallback)(()=>{G(),o.store.dispatch(l.a.setLauncherMinimized()),Q(),o.store.dispatch(l.a.setLauncherProperty("bounceTurn",3)),O.current=!1,T("WACLauncher__ButtonContainer--noAnimation")},[Q,G,o.store]);(0,N.u)(()=>{if(m)O.current=!0;else{if(!g&&M)return q(),()=>{G()};if(g&&3!==p)return z(),()=>{Q()}}}),(0,n.useEffect)(()=>{y.launcher&&O.current&&(F(),_("WACLauncherComplex__Container--simpleAnimation"),O.current=!1)},[F,y.launcher]),(0,n.useEffect)(()=>{(y.mainWindow||y.tour)&&K()},[y,K]),(0,n.useEffect)(()=>{w&&(Q(),G(),q(),o.store.dispatch(l.a.setLauncherConfigProperty("new_expand_time",!1,C.L.DESKTOP)))},[W,H,w,q,G,Q,o.store]);const X=(0,D.b)(v.desktop.title);(0,n.useEffect)(()=>{X!==v.desktop.title&&(v.desktop.title||X)&&F()},[F,v,X]);const J=(0,n.useCallback)(()=>{_("WACLauncherComplex__Container--closeAnimation"),setTimeout(()=>{T("WACLauncher__ButtonContainer--noAnimation"),o.store.dispatch(l.a.setLauncherMinimized()),setTimeout(a)},400)},[a,o.store]),ee=(0,n.useCallback)(()=>{K(),s()},[s,K]);let te;return te=m?n.createElement(Ct,{languagePack:c,intl:u,launcherComplexRef:R,launcherRef:t,launcherConfig:v,onOpen:ee,onMinimize:J,unreadHumanAgentCount:I,showUnreadIndicator:S,desktopLauncherIsExpanded:m,launcherHidden:r,activeTour:i,className:b}):n.createElement(ft,{languagePack:c,intl:u,ref:t,onToggleOpen:ee,unreadHumanAgentCount:I,showUnreadIndicator:S,className:A,launcherHidden:r,activeTour:i}),te};function vt(e,t,s,a){if(e)if(e.classList.add(t),"number"==typeof s)setTimeout(()=>{e.classList.remove(t),a&&a()},s);else{const n=r=>{s&&r.animationName!==s||(e.removeEventListener("animationend",n),e.removeEventListener("animationcancel",n),e.classList.remove(t),a&&a())};e.addEventListener("animationend",n),e.addEventListener("animationcancel",n)}}function Et(e,t){const{unreadHumanAgentCount:s,showUnreadIndicator:a,launcherConfig:r,isExtended:i,playExtendAnimation:o,onToggleOpen:c,onSwipeRight:l,onReduceEnd:u,className:h,launcherHidden:g,activeTour:m}=e,p=(0,V.u)(),S=(0,d.u)(),C=(0,f.A)(),y=(0,B.d4)(e=>e.theme.useAITheme?void 0:e.launcher.config.mobile.avatar_url_override),[v,E]=(0,n.useState)(o),[M,I]=(0,n.useState)(!1),A=(0,D.b)(i),b=(0,n.useRef)(),_=(0,n.useRef)(),P=(0,n.useRef)(),N=(0,n.useRef)(),O=(0,n.useRef)({touchStartX:null,touchStartY:null}),k=!i&&A,x=i&&v,U=i&&!v,F=r.mobile.title||S.launcher_mobileGreeting;let $=pt(S,g,m);0!==s&&($+=`. ${C.formatMessage({id:"icon_ariaUnreadMessages"},{count:s})}`);let q=n.createElement(H.A,{size:24,className:"WACLauncher__svg"});return y&&(q=n.createElement("img",{className:"WACLauncher__Avatar",src:y,"aria-hidden":!0,alt:""})),(0,n.useImperativeHandle)(t,()=>({requestFocus:()=>{(0,D.d)(b)},launcherContainerElement:()=>_.current})),(0,n.useEffect)(()=>{!function(e,t,s){const a=function(){const e=T.I?32:64,{width:t,height:s}=window.screen,a=Math.min(s,t)-e;return Math.min(a,400)}()-68+12;e.style.setProperty("width",`${a}px`),t.style.setProperty("width",a-12+"px"),t.style.setProperty("display","flex");const{clientWidth:n}=t.querySelector(".WACLauncherExtended__GreetingText");let r=n+68+1;r>400&&(r=400),t.removeAttribute("style"),e.removeAttribute("style"),s.style.setProperty("--cds-chat--LAUNCHER-EXTENDED-width",`${r}px`)}(N.current,P.current,_.current)},[p,U,F]),(0,n.useEffect)(()=>{if(i){v?wt({fadeInElement:P.current,fadeInTime:300},()=>{E(!1)}):I(!0);const e=b.current,t=e=>{!function(e,t,s){const{touchStartX:a,touchStartY:n}=t;if(null===a||null===n)return;const{clientX:r,clientY:i}=e,o=r-a,c=i-n;Math.abs(o)>Math.abs(c)&&o>0&&s(),t.touchStartX=null,t.touchStartY=null}(e.touches[0],O.current,l)},s=e=>{const{clientX:s,clientY:a}=e.touches[0],n=O.current;n.touchStartX=s,n.touchStartY=a,b.current.addEventListener("touchmove",t)};return e.addEventListener("touchstart",s),()=>{e.removeEventListener("touchmove",t),e.removeEventListener("touchstart",s)}}if(k){const e=()=>{u(),E(!0),_.current.removeEventListener("animationend",e)};_.current.addEventListener("animationend",e),wt({fadeOutElement:P.current})}},[v,p,i,F,u,l,k]),n.createElement("div",{className:R("WACLauncher__ButtonContainer WACLauncher__ButtonContainer--round WACLauncherExtended__Container",h,{"WACLauncher__ButtonContainer--hidden":g,"WACLauncherExtended__Button--extended":U,"WACLauncherExtended__Button--extendedAnimation":x,"WACLauncherExtended__Button--reducedAnimation":k}),ref:_},n.createElement(W.$nd,{"aria-label":$,className:R("WACLauncher__Button","WACLauncherExtended__Button",{WACLauncher__TourButton:m}),kind:m?w.a.GHOST:w.a.PRIMARY,type:"button",ref:b,onClick:c},n.createElement("div",{className:"WACLauncherExtended__WrapperContainer"},n.createElement("div",{className:"WACLauncherExtended__Wrapper"},n.createElement("div",{className:"WACLauncherExtended__TextHolder",ref:N},n.createElement("div",{className:R("WACLauncherExtended__Greeting",{"WACLauncherExtended__Element--hidden":!M}),ref:P},n.createElement("div",{className:"WACLauncherExtended__GreetingText","aria-hidden":!i},F))),n.createElement("div",{className:"WACLauncher__IconHolder"},m?n.createElement(L.A,{size:24,className:"WACLauncher__svg"}):q))),(0!==s||a)&&n.createElement("div",{className:"WAC__countIndicator"},0!==s?s:"")))}function wt({fadeOutElement:e,fadeInElement:t,fadeInTime:s=600},a){e&&(e.classList.remove("WACLauncherExtended__Element--hidden"),vt(e,"WACLauncherExtended__Element--FadeOut",500,()=>{e.classList.add("WACLauncherExtended__Element--hidden"),e.classList.remove("WACLauncherExtended__Element--FadeOut"),!t&&a&&a()})),t&&setTimeout(()=>{t.classList.remove("WACLauncherExtended__Element--hidden"),vt(t,"WACLauncherExtended__Element--FadeIn",600,()=>{t.classList.remove("WACLauncherExtended__Element--FadeIn"),a&&a()})},s)}const Mt=n.memo((0,n.forwardRef)(Et));function It(e){const{launcherRef:t,onToggleOpen:s,launcherHidden:a,activeTour:r}=e,i=(0,D.u)(),{config:o}=(0,B.d4)(e=>e.launcher),c=(0,B.d4)(e=>e.humanAgentState.numUnreadMessages),{mobileLauncherIsExtended:u,mobileLauncherWasReduced:d,mobileLauncherDisableBounce:h,bounceTurn:g,showUnreadIndicator:m,viewState:p}=(0,B.d4)(e=>e.persistedToBrowserStorage.launcherState),[S,f]=(0,n.useState)(!1),y=(0,D.b)(u),v=(0,D.b)(d),E=(0,n.useRef)(g).current,w=(0,n.useRef)(d).current,M=(0,n.useRef)(null),I=(0,n.useRef)(null),A=(0,n.useRef)(null),T=(0,n.useRef)(w&&!h),{time_to_expand:b,new_expand_time:_,time_to_reduce:P}=o.mobile,O=o.mobile.is_on,L=void 0===y&&!u,H=void 0!==y&&!y&&u,W=H||void 0!==v&&!v&&d||S,k=(0,n.useCallback)(()=>{d||i.store.dispatch(l.a.setLauncherProperty("mobileLauncherWasReduced",!0))},[d,i]),x=(0,n.useCallback)(()=>{!function(){const e=M.current,t=I.current;t&&(clearTimeout(t),I.current=null),e&&(clearTimeout(e),M.current=null)}(),u&&(document.removeEventListener("scroll",x),i.store.dispatch(l.a.setLauncherProperty("mobileLauncherIsExtended",!1)))},[u,i]),V=(0,n.useCallback)(()=>{M.current=setTimeout(()=>{u||H||(i.store.dispatch(l.a.setLauncherProperty("mobileLauncherWasReduced",!1)),i.store.dispatch(l.a.setLauncherProperty("mobileLauncherIsExtended",!0)))},b)},[u,H,i.store,b]),U=(0,n.useCallback)(()=>{const e=A.current;e&&(e(),A.current=null),i.store.dispatch(l.a.setLauncherProperty("mobileLauncherDisableBounce",!0)),x(),k()},[x,i.store,k]);(0,N.u)(()=>{if(!d&&L&&O)V();else if(T.current){const e=t?.current?.launcherContainerElement();if(e){const t=()=>{if(T.current){let s=E;e.removeEventListener("animationend",t),f(!0),A.current=function(e,t,s,a){const{startingIndex:n,beforeAll:r,afterAll:i,beforeEach:o,afterEach:c}=a;let l=n||0,u=!1,d=null;function h(){r&&0===l&&r();const e=l===s.length;e||u?e&&i&&i():d=setTimeout(m,s[l])}function g(){c&&c(),l++,e.removeEventListener("animationend",g),e.classList.remove(t),h()}function m(){o&&o(),e.addEventListener("animationend",g),e.classList.add(t)}return h(),()=>{u=!0,clearTimeout(d),e.classList.remove(t),e.removeEventListener("animationend",g)}}(e,"WACLauncher__ButtonContainer--bounceAnimation",Z,{startingIndex:E-1,afterEach:()=>{s++,i.store.dispatch(l.a.setLauncherProperty("bounceTurn",s))},afterAll:()=>{i.store.dispatch(l.a.setLauncherProperty("mobileLauncherDisableBounce",!0))}})}};e.addEventListener("animationend",t)}}}),(0,n.useEffect)(()=>{(p.mainWindow||p.tour)&&U()},[p,U]),(0,n.useEffect)(()=>{if(_){T.current&&(T.current=!1);const e=A.current;e&&(e(),A.current=null),M.current&&clearTimeout(M.current),V(),i.store.dispatch(l.a.setLauncherConfigProperty("new_expand_time",!1,C.L.MOBILE))}},[V,_,i.store,T]);const F=(0,n.useCallback)(()=>{U(),s()},[s,U]),$=(0,n.useCallback)(()=>{x()},[x]);return(0,n.useEffect)(()=>{u&&(I.current=setTimeout(()=>{x()},P),document.addEventListener("scroll",x))},[u,x,P,i]),n.createElement(Mt,{className:R({"WACLauncher__ButtonContainer--noAnimation":W}),ref:t,launcherConfig:o,showUnreadIndicator:m,unreadHumanAgentCount:c,isExtended:u,playExtendAnimation:L,onToggleOpen:F,onSwipeRight:$,onReduceEnd:k,launcherHidden:a,activeTour:r})}function At(){const e=(0,D.u)(),t=(0,n.useRef)(),s=(0,B.d4)(e=>e.persistedToBrowserStorage.launcherState.viewState),a=(0,B.d4)(e=>e.initialViewChangeComplete),r=!s.launcher,i=(0,B.d4)(e=>e.persistedToBrowserStorage.launcherState.activeTour),o=(0,n.useCallback)(()=>{t.current?.requestFocus()},[t]),c=(0,n.useCallback)(()=>i?e.actions.changeView(C.V.TOUR,{viewChangeReason:m.V.LAUNCHER_CLICKED}):e.actions.changeView(C.V.MAIN_WINDOW,{mainWindowOpenReason:m.b.DEFAULT_LAUNCHER}),[i,e.actions]);let l;return function(e,r){const i=(0,n.useRef)(!1);(0,n.useEffect)(()=>{i.current?s.launcher&&!s.mainWindow&&!s.tour&&a&&t.current?.requestFocus():i.current=!0},r)}(0,[s]),l=T.b?n.createElement(It,{launcherRef:t,onToggleOpen:c,launcherHidden:r,activeTour:i}):n.createElement(yt,{launcherRef:t,onDoToggle:c,requestFocus:o,launcherHidden:r,activeTour:i}),l}function Tt({onClose:e,languagePack:t,isHydrated:s,headerDisplayName:a,useHomeScreenVersion:r}){const i=(0,n.useContext)(F.a);let o;return o=r?n.createElement(q.H,{onClose:e}):n.createElement($.B,{onClose:e,headerDisplayName:a,onToggleHomeScreen:null,includeWriteableElement:!1,testIdPrefix:k.O.HYDRATING}),n.createElement("div",{className:"WAC WAC__hydratingContainer"},o,n.createElement("div",{className:R("WAC__hydrating","WACPanelContent",{"WAC__hydrating--homeScreen":r})},!i&&n.createElement(V.M,{delay:400},!s&&n.createElement(h.A,{announceOnce:t.window_ariaWindowLoading}),n.createElement(W.Rhj,{withOverlay:!1,"aria-label":t.window_ariaWindowLoading}))))}function bt(e){const{useAITheme:t,onPanelOpenEnd:s,onPanelCloseEnd:a,onPanelOpenStart:r,onPanelCloseStart:i,onClose:o,onCloseAndRestart:c,onClickRestart:u}=e,h=(0,d.u)(),{isOpen:g,options:p}=(0,B.d4)(e=>e.customPanelState),{title:S,hidePanelHeader:f,disableDefaultCloseAction:C,disableAnimation:y,onClickBack:v,onClickClose:E,onClickCloseAndRestart:w}=p,M=(0,D.u)(),I=(0,V.u)(),A=(0,D.b)(g),T=y?k.b.NONE:k.b.SLIDE_IN_FROM_BOTTOM,b=y?k.A.NONE:k.A.SLIDE_OUT_TO_BOTTOM;(0,n.useEffect)(()=>{A!==g&&g&&!f&&S&&I(S)},[I,f,g,A,S]);const _=(0,n.useCallback)(()=>{M.store.dispatch(l.a.setCustomPanelOpen(!1)),v?.()},[M,v]),R=(0,n.useCallback)(()=>{C||(_t(M.store.getState().viewChanging),o()),E?.()},[C,E,o,M]),P=(0,n.useCallback)(()=>{C||(_t(M.store.getState().viewChanging),c()),w?.()},[C,w,c,M]);return n.createElement(k.a,{className:"WAC__overlay--covering",onOpenStart:()=>{M.eventBus.fire({type:m.B.CUSTOM_PANEL_PRE_OPEN},M.instance),r()},onOpenEnd:()=>{M.eventBus.fire({type:m.B.CUSTOM_PANEL_OPEN},M.instance),s()},onCloseStart:()=>{M.eventBus.fire({type:m.B.CUSTOM_PANEL_PRE_CLOSE},M.instance),i()},onCloseEnd:()=>{M.eventBus.fire({type:m.B.CUSTOM_PANEL_CLOSE},M.instance),a(),M.store.dispatch(l.a.setCustomPanelConfigOptions(te))},animationOnOpen:T,animationOnClose:b,shouldOpen:g,serviceManager:M,overlayPanelName:k.O.CUSTOM},n.createElement(G.B,{className:"WACCustomPanel",eventName:"Custom panel opened",eventDescription:"A user opened a custom panel.",labelBackButton:h.general_returnToAssistant,isOpen:g,title:S,useAITheme:t,onClickBack:_,onClickClose:R,onClickCloseAndRestart:P,onClickRestart:u,hidePanelHeader:f,hideBackButton:p.hideBackButton,hideCloseButton:p.hideCloseButton,hideCloseAndRestartButton:p.hideCloseAndRestartButton,testIdPrefix:k.O.CUSTOM},n.createElement(j.a,{slotName:"customPanelElement",className:"WACCustomPanel__ContentContainer"})))}function _t(e){if(e){const e="You are attempting to close Carbon AI chat from a custom panel while Carbon AI chat is currently running a view change event which is not permitted. Please use the disableDefaultCloseAction option to disable this behavior for the custom panel and then use onClickClose to resolve your Promise that is handling the event; that Promise will allow you to close Carbon AI chat.";throw(0,g.b)(e),new Error(e)}}const Rt=n.memo(bt),Bt=(0,C.i)(),Dt=(0,C.j)(),Pt=(0,C.k)(),Nt=(0,C.m)(),Ot=(0,C.n)(),Lt=(0,C.o)(),Ht=(0,C.p)(),Wt="WAC--standardWidth",kt="WAC--narrowWidth",xt="WAC--wideWidth";class Vt extends n.Component{constructor(){super(...arguments),this.state={closing:!1,open:this.props.persistedToBrowserStorage.launcherState.viewState.mainWindow,modalPortalHostElement:null,numPanelsOpen:0,numPanelsAnimating:0,numPanelsCovering:0,isHydrationAnimationComplete:this.props.isHydrated,shouldAutoFocus:this.props.config.public.shouldTakeFocusIfOpensAutomatically,extraClassNames:[],areModulesLoaded:!1},this.mainWindowRef=n.createRef(),this.containerRef=n.createRef(),this.botChatRef=n.createRef(),this.homeScreenInputRef=n.createRef(),this.disclaimerRef=n.createRef(),this.brandingRef=n.createRef(),this.animationContainerRef=n.createRef(),this.iframePanelRef=n.createRef(),this.viewSourcePanelRef=n.createRef(),this.previousBodyVisibility=void 0,this.previousBodyPosition=void 0,this.onResize=()=>{let e;const t=this.containerRef?.current?.offsetHeight,s=this.containerRef?.current?.offsetWidth;e=s>=704?d.C.WIDE:s>=360?d.C.STANDARD:d.C.NARROW,this.props.serviceManager.store.dispatch(l.a.setAppStateValue("chatWidth",s)),this.props.serviceManager.store.dispatch(l.a.setAppStateValue("chatHeight",t)),this.props.serviceManager.store.dispatch(l.a.setAppStateValue("chatWidthBreakpoint",e))},this.onVisualViewportResize=()=>{this.updateFromVisualViewport()},this.updateFromVisualViewport=()=>{const e=this.props.serviceManager.container,{visualViewport:t}=window;if(t)e.style.setProperty("--cds-chat-viewport-height",`${t.height}px`),e.style.setProperty("--cds-chat-viewport-width",`${t.width}px`),e.style.setProperty("--cds-chat-viewport-offsetTop",`${t.offsetTop}px`),e.style.setProperty("--cds-chat-viewport-offsetLeft",`${t.offsetLeft}px`);else{const t="100vh";e.style.setProperty("--cds-chat-viewport-height",t),e.style.setProperty("--cds-chat-viewport-width","100vw"),e.style.setProperty("--cds-chat-viewport-offsetTop","0"),e.style.setProperty("--cds-chat-viewport-offsetLeft","0")}},this.setModalPortalHostElement=e=>{this.state.modalPortalHostElement!==e&&this.setState({modalPortalHostElement:e})},this.onSendInput=async(e,t,s)=>{const a=(0,u.b)(this.props),{serviceManager:n}=this.props,r=n.store.getState(),{files:i}=(0,u.a)(r);if(a)n.humanAgentService.sendMessageToAgent(e,i);else{const a=(0,M.k)(e);n.actions.sendWithCatch(a,t,{...s})}i.length&&n.store.dispatch(l.a.clearInputFiles(a))},this.onSendHomeButtonInput=e=>{const t=(0,M.D)(e);this.props.serviceManager.actions.sendWithCatch(t,m.M.HOME_SCREEN_STARTER)},this.removeChatFromDom=()=>{this.containerRef.current.removeEventListener("animationend",this.removeChatFromDom),this.setState({open:!1,closing:!1})},this.onRestart=async()=>{await this.props.serviceManager.actions.restartConversation(),this.requestFocus()},this.onClose=async()=>this.doClose(!1),this.onCloseAndRestart=async()=>this.doClose(!0),this.onToggleHomeScreen=()=>{this.props.serviceManager.store.dispatch(l.a.toggleHomeScreen())},this.requestFocus=()=>{try{this.state.shouldAutoFocus&&!T.I&&(this.getShowDisclaimer()?this.disclaimerRef.current&&(0,D.d)(this.disclaimerRef):this.getShowHomeScreen()?this.homeScreenInputRef.current&&this.homeScreenInputRef.current.takeFocus():this.props.iFramePanelState.isOpen?this.iframePanelRef.current&&this.iframePanelRef.current.requestFocus():this.botChatRef.current&&this.botChatRef.current.requestInputFocus())}catch(e){(0,g.b)("An error occurred in MainWindow.requestFocus",e)}},this.onUserTyping=e=>{this.props.serviceManager.store.getState().persistedToBrowserStorage.chatState.humanAgentState.isConnected&&this.props.serviceManager.humanAgentService.userTyping(e)},this.onAcceptDisclaimer=()=>{this.props.serviceManager.store.dispatch(l.a.acceptDisclaimer())},this.onPanelOpenStart=e=>{this.setState(t=>({numPanelsOpen:t.numPanelsOpen+1,numPanelsAnimating:t.numPanelsAnimating+1,numPanelsCovering:t.numPanelsCovering+(e?1:0)}),this.requestFocus)},this.onPanelOpenEnd=()=>{this.setState(e=>({numPanelsAnimating:e.numPanelsAnimating-1}))},this.onPanelCloseStart=()=>{this.setState(e=>({numPanelsAnimating:e.numPanelsAnimating+1}),this.requestFocus)},this.onPanelCloseEnd=e=>{this.setState(t=>({numPanelsOpen:t.numPanelsOpen-1,numPanelsAnimating:t.numPanelsAnimating-1,numPanelsCovering:t.numPanelsCovering-(e?1:0)}))},this.onHydrationPanelClose=()=>{this.setState({isHydrationAnimationComplete:!0},this.requestFocus)}}componentDidMount(){const{persistedToBrowserStorage:e,config:t,serviceManager:s,mainWindowRef:a}=this.props,{viewState:n}=e.launcherState,{public:r}=t;if(s.mainWindow=this,a.current=this,this.mainWindowObserver=new ResizeObserver(this.onResize),this.mainWindowObserver.observe(this.containerRef.current),T.I&&!r.disableCustomElementMobileEnhancements){const{visualViewport:e}=window;e&&(e.addEventListener("resize",this.onVisualViewportResize),e.addEventListener("scroll",this.updateFromVisualViewport)),this.updateFromVisualViewport(),this.updateBody(!1)}this.containerRef.current.style.setProperty("--cds-chat-scrollbar-width",`${(0,D.c)()}px`),n.mainWindow&&this.loadPanels()}componentWillUnmount(){this.mainWindowObserver.unobserve(this.containerRef.current)}destroy(){if(T.I&&!this.props.config.public.disableCustomElementMobileEnhancements){const{visualViewport:e}=window;e&&(e.removeEventListener("resize",this.onVisualViewportResize),e.removeEventListener("scroll",this.updateFromVisualViewport))}this.updateBody(!0)}componentDidUpdate(e,t){const s=this.props,a=this.state,{persistedToBrowserStorage:n,useCustomHostElement:r,isDestroyed:i}=s,{viewState:o}=n.launcherState,{open:c}=a,l=e.persistedToBrowserStorage.launcherState.viewState;o.mainWindow!==l.mainWindow&&(this.updateBody(!1),this.updateFromVisualViewport()),i&&!e.isDestroyed&&this.destroy(),(t.areModulesLoaded!==a.areModulesLoaded||e.isHydrated!==s.isHydrated)&&s.isHydrated&&a.areModulesLoaded&&this.setState({isHydrationAnimationComplete:!0},()=>{requestAnimationFrame(()=>{this.requestFocus()})}),!o.mainWindow||l.mainWindow&&c?!o.mainWindow&&l.mainWindow&&t.open&&c&&(this.setState({closing:!0}),r?this.removeChatFromDom():(this.containerRef.current.addEventListener("animationend",this.removeChatFromDom),this.requestFocus())):(this.setState({open:!0},()=>{this.requestFocus()}),this.loadPanels()),s.config.public.shouldTakeFocusIfOpensAutomatically&&(e.persistedToBrowserStorage.chatState.hasSentNonWelcomeMessage||!s.persistedToBrowserStorage.chatState.hasSentNonWelcomeMessage||this.state.shouldAutoFocus?e.botMessageState.localMessageIDs.length>s.botMessageState.localMessageIDs.length&&this.state.shouldAutoFocus?this.setState({shouldAutoFocus:!1}):e.botMessageState.localMessageIDs.length<s.botMessageState.localMessageIDs.length&&!this.state.shouldAutoFocus&&this.setState({shouldAutoFocus:!0}):this.setState({shouldAutoFocus:!0}));const u=(0,M.f)(s.botMessageState.localMessageIDs);if(u!==(0,M.f)(e.botMessageState.localMessageIDs)&&a.shouldAutoFocus){const e=s.allMessageItemsByID[u],t=s.allMessagesByID[e?.fullMessageID];t?.ui_state_internal?.from_history||this.requestFocus()}}componentDidCatch(e,t){this.props.serviceManager.actions.errorOccurred((0,g.a)("MainWindow",e,t,!0))}loadPanels(){Promise.all([Bt.preload(),Dt.preload(),Pt.preload(),Nt.preload(),Ot.preload(),Lt.preload(),Ht.preload()]).then(()=>{this.setState({areModulesLoaded:!0})})}updateBody(e){T.c&&!this.props.config.public.disableCustomElementMobileEnhancements&&((window.screen.width<=500||window.screen.height<=500)&&this.props.persistedToBrowserStorage.launcherState.viewState.mainWindow&&!e?(this.previousBodyVisibility=document.body.style.getPropertyValue("visibility"),this.previousBodyPosition=document.body.style.getPropertyValue("position"),document.body.style.setProperty("visibility","hidden","important"),document.body.style.setProperty("position","fixed","important")):(document.body.style.setProperty("visibility",this.previousBodyVisibility),document.body.style.setProperty("position",this.previousBodyPosition)))}async doClose(e){const{serviceManager:t}=this.props,{activeTour:s}=t.store.getState().persistedToBrowserStorage.launcherState;e?(await t.actions.changeView(C.V.LAUNCHER,{mainWindowCloseReason:m.d.MAIN_WINDOW_CLOSED_AND_RESTARTED})).mainWindow||await t.actions.restartConversation():await t.actions.changeView(s?C.V.TOUR:C.V.LAUNCHER,{mainWindowCloseReason:m.d.DEFAULT_MINIMIZE})}getShowHomeScreen(){return this.props.homeScreenConfig.is_on&&this.props.persistedToBrowserStorage.chatState.homeScreenState.isHomeScreenOpen&&!this.getShowDisclaimer()}getShowDisclaimer(){return this.props.config.public.disclaimer?.is_on&&!this.props.persistedToBrowserStorage.chatState.disclaimersAccepted[window.location.hostname]}doAutoScroll(e){this.botChatRef?.current?.doAutoScroll(e)}getMessagesScrollBottom(){return this.botChatRef?.current?.getMessagesScrollBottom()}doScrollToMessage(e,t=!0){this.botChatRef.current?.doScrollToMessage(e,t)}getMessageInput(){return this.botChatRef.current?.getMessageInput()}getHomeScreenInput(){return this.homeScreenInputRef.current?.getMessageInput()}addClassName(e){this.setState(function(e){return t=>-1===t.extraClassNames.indexOf(e)?{extraClassNames:[...t.extraClassNames,e]}:null}(e))}removeClassName(e){this.setState(function(e){return t=>({extraClassNames:t.extraClassNames.filter(t=>t!==e)})}(e))}renderChat(){const{isHydrated:e,config:t,chatWidthBreakpoint:s}=this.props,{areModulesLoaded:a}=this.state,r=this.state.numPanelsCovering>0&&t.public.layout?.hasContentMaxWidth&&s===d.C.WIDE;return n.createElement("div",{className:"WACWidget--content"},this.renderCustomPanel(),this.renderHydrationPanel(),e&&a&&n.createElement(n.Fragment,null,this.renderDisclaimerPanel(),this.renderResponsePanel(),this.renderHomeScreenPanel(),this.renderIFramePanel(),this.renderViewSourcePanel(),r&&n.createElement("div",{className:"WACBackgroundCover"}),this.renderBotChat()))}renderBotChat(){const{botName:e,languagePack:t,config:s,serviceManager:a,botMessageState:r,humanAgentState:i,allMessageItemsByID:o,isHydrated:c,locale:l,theme:d,headerDisplayName:h,headerAvatarConfig:g}=this.props,{numPanelsAnimating:p,numPanelsOpen:S,isHydrationAnimationComplete:f}=this.state,C=(0,u.a)(this.props),y=(0,u.s)(this.props),v=this.getShowDisclaimer();let E;return f?p>0?E=!1:S>0&&(E=!0):E=!0,n.createElement(F.H,{className:"WACBotContainer",hidden:E},n.createElement(n.Suspense,{fallback:null},n.createElement(Bt,{botName:e,headerDisplayName:h,headerAvatarConfig:g,ref:this.botChatRef,languagePack:t,config:s,serviceManager:a,onClose:this.onClose,onCloseAndRestart:this.onCloseAndRestart,messageState:r,onSendInput:e=>this.onSendInput(e,m.M.MESSAGE_INPUT),humanAgentState:i,agentDisplayState:y,allMessageItemsByID:o,onRestart:this.onRestart,isHydrated:c,isHydrationAnimationComplete:f&&!v,inputState:C,onToggleHomeScreen:this.onToggleHomeScreen,onUserTyping:this.onUserTyping,locale:l,useAITheme:d.useAITheme,carbonTheme:d.carbonTheme})))}renderInnerHydrationPanel(){const{botMessageState:e,serviceManager:t,languagePack:s,headerDisplayName:a,persistedToBrowserStorage:r,homeScreenConfig:i}=this.props,{areModulesLoaded:o}=this.state,c=i.is_on&&!r.launcherState.hasSentNonWelcomeMessage;return n.createElement(Tt,{headerDisplayName:a,isHydrated:0===e.isHydratingCounter&&o,serviceManager:t,onClose:this.onClose,languagePack:s,useHomeScreenVersion:c})}renderHydrationPanel(){const{botMessageState:e,serviceManager:t,catastrophicErrorType:s,persistedToBrowserStorage:a}=this.props,{viewState:r}=a.launcherState,{areModulesLoaded:i}=this.state;return n.createElement(k.a,{onOpenStart:()=>this.onPanelOpenStart(!1),onCloseStart:this.onPanelCloseStart,onOpenEnd:this.onPanelOpenEnd,onCloseEnd:()=>{this.onHydrationPanelClose(),this.onPanelCloseEnd(!1)},animationOnOpen:k.b.NONE,animationOnClose:k.A.NONE,shouldOpen:(e.isHydratingCounter>0||!i)&&!s&&r.mainWindow,shouldHide:!1,serviceManager:t,overlayPanelName:k.O.HYDRATING},this.renderInnerHydrationPanel())}renderCatastrophicPanel(){const{serviceManager:e,botName:t,languagePack:s,headerDisplayName:a}=this.props;return n.createElement(k.a,{animationOnOpen:k.b.NONE,animationOnClose:k.A.NONE,shouldOpen:!0,serviceManager:e,overlayPanelName:k.O.CATASTROPHIC},n.createElement(n.Suspense,{fallback:null},n.createElement(Dt,{onClose:this.onClose,headerDisplayName:a,languagePack:s,onRestart:this.onRestart,showHeader:!0,botName:t})))}renderDisclaimerPanel(){const{serviceManager:e,config:t}=this.props,s=this.getShowDisclaimer();return t.public.disclaimer?.is_on?n.createElement(k.a,{onOpenStart:()=>this.onPanelOpenStart(!1),onCloseStart:this.onPanelCloseStart,onOpenEnd:this.onPanelOpenEnd,onCloseEnd:()=>this.onPanelCloseEnd(!1),animationOnOpen:k.b.FADE_IN,animationOnClose:k.A.FADE_OUT,shouldOpen:s,serviceManager:e,overlayPanelName:k.O.DISCLAIMER},n.createElement(n.Suspense,{fallback:null},n.createElement(Pt,{onAcceptDisclaimer:this.onAcceptDisclaimer,onClose:this.onClose,disclaimerHTML:t.public.disclaimer?.disclaimerHTML,disclaimerAcceptButtonRef:this.disclaimerRef}))):null}renderHomeScreenPanel(){const{isHydrationAnimationComplete:e}=this.state,t=this.getShowHomeScreen();return n.createElement(n.Suspense,{fallback:null},n.createElement(Nt,{onPanelOpenStart:()=>this.onPanelOpenStart(!1),onPanelOpenEnd:this.onPanelOpenEnd,onPanelCloseStart:this.onPanelCloseStart,onPanelCloseEnd:()=>this.onPanelCloseEnd(!1),onClose:this.onClose,onCloseAndRestart:this.onCloseAndRestart,onSendBotInput:e=>this.onSendInput(e,m.M.HOME_SCREEN_INPUT),onSendButtonInput:this.onSendHomeButtonInput,onRestart:this.onRestart,showHomeScreen:t,isHydrationAnimationComplete:e,homeScreenInputRef:this.homeScreenInputRef,onToggleHomeScreen:this.onToggleHomeScreen,requestFocus:this.requestFocus}))}renderIFramePanel(){const{serviceManager:e,iFramePanelState:t}=this.props;return n.createElement(k.a,{className:"WAC__overlay--covering",onOpenStart:()=>this.onPanelOpenStart(!0),onCloseStart:this.onPanelCloseStart,onOpenEnd:this.onPanelOpenEnd,onCloseEnd:()=>this.onPanelCloseEnd(!0),animationOnOpen:k.b.SLIDE_IN_FROM_BOTTOM,animationOnClose:k.A.SLIDE_OUT_TO_BOTTOM,shouldOpen:t.isOpen,serviceManager:e,overlayPanelName:k.O.IFRAME},n.createElement(n.Suspense,{fallback:null},n.createElement(Ot,{useAITheme:this.props.theme.useAITheme,ref:this.iframePanelRef,onClickClose:this.onClose,onClickRestart:this.onRestart,onClickCloseAndRestart:this.onCloseAndRestart})))}renderViewSourcePanel(){const{serviceManager:e,viewSourcePanelState:t}=this.props;return n.createElement(k.a,{className:"WAC__overlay--covering",onOpenStart:()=>this.onPanelOpenStart(!0),onCloseStart:this.onPanelCloseStart,onOpenEnd:this.onPanelOpenEnd,onCloseEnd:()=>this.onPanelCloseEnd(!0),animationOnOpen:k.b.SLIDE_IN_FROM_BOTTOM,animationOnClose:k.A.SLIDE_OUT_TO_BOTTOM,shouldOpen:t.isOpen,serviceManager:e,overlayPanelName:k.O.CONVERSATIONAL_SEARCH_CITATION},n.createElement(n.Suspense,{fallback:null},n.createElement(Lt,{ref:this.viewSourcePanelRef,onClickClose:this.onClose,onClickRestart:this.onRestart,onClickCloseAndRestart:this.onCloseAndRestart})))}renderCustomPanel(){return n.createElement(Rt,{useAITheme:this.props.theme.useAITheme,onClose:this.onClose,onClickRestart:this.onRestart,onCloseAndRestart:this.onCloseAndRestart,onPanelOpenStart:()=>this.onPanelOpenStart(!0),onPanelOpenEnd:this.onPanelOpenEnd,onPanelCloseStart:this.onPanelCloseStart,onPanelCloseEnd:()=>this.onPanelCloseEnd(!0)})}renderResponsePanel(){if(!this.props.responsePanelState.localMessageItem)return null;const{isOpen:e,localMessageItem:t,isMessageForInput:s}=this.props.responsePanelState,a=(t?.item).panel,r=k.O.PANEL_RESPONSE;return n.createElement(n.Suspense,{fallback:null},n.createElement(Ht,{eventName:'"Show panel" opened',eventDescription:"Panel opened through panel response type",overlayPanelName:r,testIdPrefix:r,isOpen:e,isMessageForInput:s,localMessageItem:t,title:a?.title,showAnimations:a?.show_animations,useAITheme:this.props.theme.useAITheme,requestFocus:this.requestFocus,onClose:this.onClose,onClickRestart:this.onRestart,onCloseAndRestart:this.onCloseAndRestart,onClickBack:()=>this.props.serviceManager.store.dispatch(l.a.setResponsePanelIsOpen(!1)),onPanelOpenStart:()=>this.onPanelOpenStart(!0),onPanelOpenEnd:this.onPanelOpenEnd,onPanelCloseStart:this.onPanelCloseStart,onPanelCloseEnd:()=>{this.onPanelCloseEnd(!0),this.props.serviceManager.store.dispatch(l.a.setResponsePanelContent(null,!1))},renderMessageComponent:e=>n.createElement(P.M,{...e})}))}renderWidget(){const{serviceManager:e,useCustomHostElement:t,locale:s,catastrophicErrorType:a,config:r,isHydrated:i,theme:o,chatWidthBreakpoint:c,layout:l,languagePack:u}=this.props,{closing:g,open:m,extraClassNames:p}=this.state,S=`WACLocale-${s||"en"}`,f=r.public.enableFocusTrap&&m&&!r.public.hideCloseButton&&!r.public.headerConfig.hideMinimizeButton,y=Boolean(f&&i),v=c===d.C.WIDE;return n.createElement(U,{active:y},n.createElement("div",{className:R("WACMainWindow","WACWidget__FocusTrapContainer",...p),ref:this.mainWindowRef},f&&n.createElement("div",{className:"WACWidget__FocusTrapGlass"}),n.createElement("div",{id:`WACWidget${e.namespace.suffix}`,className:R(`WACWidget ${S}`,{"WACWidget--rounded":o.corners===C.a.ROUND,"WACWidget--defaultElement":!t,"WACWidget--launched":!g,"WACWidget--closing":g,"WACWidget--closed":!m,"WACWidget--maxWidth":v&&l.hasContentMaxWidth,[kt]:c===d.C.NARROW,[Wt]:c===d.C.STANDARD,[xt]:v}),ref:this.containerRef},n.createElement(h.V,null,n.createElement("h1",null,u.window_title)),a&&this.renderCatastrophicPanel(),!a&&n.createElement("div",{ref:this.animationContainerRef,className:"WACWidget__animationContainer",onScroll:()=>{0!==this.animationContainerRef.current.scrollTop&&(this.animationContainerRef.current.scrollTop=0)}},this.renderChat()),n.createElement("div",{className:"WACMainWindowModalHost",ref:this.setModalPortalHostElement}))))}render(){return n.createElement(j.M.Provider,{value:this.state.modalPortalHostElement},this.renderWidget())}}var Ut=(0,B.Ng)(e=>e,null,null,{forwardRef:!0})(Vt);const Ft=(0,C.q)();function $t({serviceManager:e,hostElement:t,applicationStyles:s,fontStyles:a}){const{store:r}=e,{config:i}=r.getState();i.public.debug&&(0,g.d)("[render] Called render");const o=`${a?`${a} `:""}${s}`;return n.createElement(B.Kq,{store:r},n.createElement(qt,{serviceManager:e,hostElement:t,applicationStyles:o}))}function qt({serviceManager:e,hostElement:t,applicationStyles:s}){const a=(0,B.d4)(e=>e.languagePack),r=(0,B.d4)(e=>e.cssVariableOverrides),i=(0,B.d4)(e=>e.theme),o=(0,B.d4)(e=>e.config),c=(0,B.d4)(e=>e.layout),{namespace:u}=e,{originalName:h}=u,g=(0,B.wA)(),[m,p]=(0,n.useState)({width:window.innerWidth,height:window.innerHeight}),f=(0,n.useMemo)(()=>function(e){let t="";const s=Object.keys(e).map(t=>{const s=e[t];return void 0===s?"":`${t.startsWith("$")?`${_e}${t.replace(/^\$/,"")}`:`${_e}chat-${t}`}:${s};`}).join("");return s.length>0&&(t=`.WACContainer .cds--white, .WACContainer .cds--g10, .WACContainer .cds--g90, .WACContainer .cds--g100, :host{${s}}`),t}(r),[r]),C=document.dir||"auto";return(0,N.u)(()=>{const e=()=>{p({width:window.innerWidth,height:window.innerHeight})};window.addEventListener("resize",e);const t=()=>{g(l.a.setIsBrowserPageVisible("visible"===document.visibilityState))};return document.addEventListener("visibilitychange",t),()=>{window.removeEventListener("resize",e),document.removeEventListener("visibilitychange",t)}}),n.createElement("div",{className:"WACContainer","data-namespace":h,ref:e=>{e&&t&&(e.style.setProperty("height","100%","important"),e.style.setProperty("width","100%","important"))}},n.createElement("div",{className:"WACContainer--styles"},n.createElement("style",{"data-base-styles":"true",nonce:o.public.cspNonce},s||".WACContainer { visibility: hidden; }"),n.createElement("style",{"data-variables-custom":"true",nonce:o.public.cspNonce},f)),n.createElement("div",{className:R("WACContainer--render",Le(i),{"WACContainer-disableMobileEnhancements":t&&o.public.disableCustomElementMobileEnhancements,"WAC-isPhone":T.b&&!o.public.disableCustomElementMobileEnhancements,"WAC-isPhonePortraitMode":T.d&&!o.public.disableCustomElementMobileEnhancements,"WAC--frameless":!c?.showFrame}),dir:C},n.createElement(P.W.Provider,{value:m},n.createElement(D.S.Provider,{value:e},n.createElement(S.Kq,{value:e.intl},n.createElement(d.L.Provider,{value:a},n.createElement(mt,null,n.createElement(Gt,{serviceManager:e,hostElement:t}))))))))}function Gt(e){const{hostElement:t,serviceManager:s}=e,a=(0,B.d4)(e=>e.launcher.config.is_on),{viewState:r}=(0,B.d4)(e=>e.persistedToBrowserStorage.launcherState),i=(0,n.useRef)(),o=(0,n.useRef)(),c=r.tour,l=(0,n.useRef)(c);l.current=c||l.current;const u=(0,f.A)(),d=s.namespace.originalName,h=d?"window_ariaChatRegionNamespace":"window_ariaChatRegion",m=u.formatMessage({id:h},{namespace:d});return(0,N.u)(()=>{s.appWindow={requestFocus:function(){try{const{persistedToBrowserStorage:e}=s.store.getState(),{viewState:t}=e.launcherState;t.tour?i.current?.requestFocus():t.mainWindow&&o.current?.requestFocus()}catch(e){(0,g.b)("An error occurred in App.requestFocus",e)}}}}),n.createElement("div",{className:"WACWidget__regionContainer",role:"region","aria-label":m},n.createElement(Ut,{mainWindowRef:o,useCustomHostElement:Boolean(t),serviceManager:s}),l.current&&n.createElement(n.Suspense,{fallback:null},n.createElement(Ft,{ref:i})),a&&n.createElement(At,null))}function jt({chatInstance:e,renderUserDefinedResponse:t,userDefinedResponseEventsBySlot:s}){return t?Object.entries(s).map(([s,a])=>{const{element:r}=a;return r?n.createElement(Yt,{key:s,hostElement:r},t(a,e)):null}):null}function Yt({hostElement:e,children:t}){return Y.createPortal(t,e)}const zt=n.memo(jt);function Qt({chatInstance:e,renderResponseMap:t}){return n.createElement(n.Fragment,null,Object.keys(e.writeableElements).map(s=>{const a=t[s];return a?n.createElement(Kt,{key:s,hostElement:e.writeableElements[s]},a):null}))}function Kt({hostElement:e,children:t}){return Y.createPortal(t,e)}const Xt=n.memo(Qt);function Jt({config:e,onBeforeRender:t,onAfterRender:s,renderUserDefinedResponse:r,renderWriteableElements:i,container:o,setParentInstance:l,element:u}){const[d,h]=(0,n.useState)(null),[p,S]=(0,n.useState)(null),[f,C]=(0,n.useState)(null),y=e=>{h(e),l?.(e)},[v,E]=(0,n.useState)({}),w=(0,n.useRef)(null),M=(0,n.useRef)(null);return(0,n.useEffect)(()=>{const n=M.current;if(M.current=e,!(0,a.A)(n,e)){const a={instance:null,shouldDestroy:!1,config:e};return e&&async function({managedWebChatRef:e,managedWebChat:t,render:s,setInstance:a,onBeforeRender:n,onAfterRender:r,setUserDefinedResponseEventsBySlot:i,element:o}){if(await Zt(e.current,a),e.current=t,t.shouldDestroy)return void await Zt(t,a);const l=await async function(e,t,s,a){const n=(0,c.A)(e);if(!n.messaging?.customSendMessage)throw new Error("You must set messaging.customSendMessage in your configuration object.");n?.debug&&(0,g.d)("[ChatEntry] Called instantiateWidget",n),"https:"!==document.location.protocol&&(0,g.c)('Your page is not running with "https"; your data will not be sent  securely.'),"CSS1Compat"!==document.compatMode&&(0,g.c)('Your page is running in quirks mode; you may experience layout issues with the chat. Add "<!DOCTYPE html>" to the page to run in standards mode.');const{onError:r,...i}=n;return new(await Promise.resolve(gt))(i,a,{onError:r,render:s})}(t.config,0,Promise.resolve(s),o),u=await l.start();(function(e,t){e.on({type:m.B.CHUNK_USER_DEFINED_RESPONSE,handler:function(e){if("complete_item"in e.data.chunk){const s=e.data.chunk.complete_item;t(t=>({...t,[e.data.slot]:{messageItem:s,element:e.data.element}}))}else if("partial_item"in e.data.chunk){const s=e.data.chunk.partial_item;t(t=>({...t,[e.data.slot]:{partialItems:[...t[e.data.slot]?.partialItems||[],s],element:e.data.element}}))}}}),e.on({type:m.B.USER_DEFINED_RESPONSE,handler:function(e){t(t=>({...t,[e.data.slot]:{fullMessage:e.data.fullMessage,messageItem:e.data.message,element:e.data.element}}))}}),e.on({type:m.B.RESTART_CONVERSATION,handler:function(){t({})}})})(u,i),n?.(u),await u.render(),r?.(u),a(u),t.instance=u,t.shouldDestroy&&await Zt(t,a)}({managedWebChatRef:w,managedWebChat:a,render:async function({serviceManager:e}){const t=await async function(){const[e,t]=await Promise.all([ts(),ss()]);return t+e}();e.container=o,e.customHostElement?(o.style.setProperty("width","100%","important"),o.style.setProperty("height","100%","important")):(o.style.setProperty("width","0","important"),o.style.setProperty("height","0","important")),C(t),S({serviceManager:e}),await(0,g.s)(0)},setInstance:y,onBeforeRender:t,onAfterRender:s,setUserDefinedResponseEventsBySlot:E,element:u}),()=>{Zt(a,y),M.current=null}}},[e,o]),p&&d?n.createElement(n.Fragment,null,n.createElement($t,{serviceManager:p.serviceManager,hostElement:p.serviceManager.customHostElement,applicationStyles:f}),r&&n.createElement(zt,{chatInstance:d,renderUserDefinedResponse:r,userDefinedResponseEventsBySlot:v}),i&&n.createElement(Xt,{chatInstance:d,renderResponseMap:i})):null}async function Zt(e,t){e&&(e.instance&&(e.instance.destroy(),await(0,g.s)(0)),e.shouldDestroy=!0,e.instance=null),t(null),await(0,g.s)(0)}const es=n.memo(Jt),ts=async()=>{const{default:e}=await s.e(9518).then(s.bind(s,9518));return e},ss=async()=>{const{default:e}=await s.e(8327).then(s.bind(s,8327));return e}}}]);
//# sourceMappingURL=9362.bundle.js.map